<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Varalife Creative Performance Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@600;700;800&family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap');

  :root {
    --primary: #060237;
    --accent: #8A38F5;
    --accent-light: #A855F7;
    --accent-dim: rgba(138,56,245,0.08);
    --bg: #F0F0F0;
    --bg-card: #FFFFFF;
    --bg-card-hover: #FAFAFA;
    --border: #E5E5E5;
    --border-strong: #888888;
    --text: #060237;
    --text-muted: #6B7280;
    --text-dim: #9CA3AF;
    --text-on-dark: #FFFFFF;
    --nav-bg: #060237;
    --green: #16A34A;
    --green-dim: rgba(22,163,74,0.1);
    --red: #DC2626;
    --red-dim: rgba(220,38,38,0.1);
    --yellow: #CA8A04;
    --yellow-dim: rgba(202,138,4,0.1);
    --blue: #2563EB;
    --blue-dim: rgba(37,99,235,0.1);
    --purple: #8A38F5;
    --purple-dim: rgba(138,56,245,0.1);
    --orange: #EA580C;
    --orange-dim: rgba(234,88,12,0.1);
    --cyan: #0891B2;
    --font-display: 'Plus Jakarta Sans', sans-serif;
    --font-body: 'DM Sans', sans-serif;
    --font-mono: 'JetBrains Mono', monospace;
    --radius-sm: 4px;
    --radius-md: 8px;
    --radius-lg: 12px;
    --radius-pill: 100px;
    --shadow-sm: 0 1px 2px rgba(6,2,55,0.05);
    --shadow-md: 0 4px 12px rgba(6,2,55,0.08);
    --shadow-lg: 0 8px 24px rgba(6,2,55,0.12);
    --shadow-glow: 0 0 16px rgba(138,56,245,0.2);
  }

  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family: var(--font-body);
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
  }
  .container { max-width: 1400px; margin: 0 auto; padding: 0 24px; }

  /* ── Login Screen ── */
  .login-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: var(--primary); z-index: 2000;
    display: flex; align-items: center; justify-content: center;
  }
  .login-overlay.hidden { display: none; }
  .login-box {
    background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12);
    border-radius: 20px; padding: 40px; width: 380px;
    text-align: center; backdrop-filter: blur(20px);
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  }
  .login-box h2 {
    font-size: 24px; font-weight: 800;
    font-family: var(--font-display);
    background: linear-gradient(135deg, #A855F7, #8A38F5, #6D28D9);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    margin-bottom: 4px;
  }
  .login-box .login-sub { font-size: 13px; color: rgba(255,255,255,0.5); margin-bottom: 28px; }
  .login-box input {
    width: 100%; padding: 12px 16px; border-radius: var(--radius-lg);
    background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.15);
    color: #FFFFFF; font-size: 14px; font-family: inherit;
    margin-bottom: 12px; outline: none;
  }
  .login-box input:focus { border-color: var(--accent); }
  .login-box button {
    width: 100%; padding: 12px; border-radius: var(--radius-pill);
    background: var(--accent); color: #fff; border: none;
    font-size: 14px; font-weight: 600; cursor: pointer;
    font-family: inherit; margin-top: 4px;
  }
  .login-box button:hover { background: var(--accent-light); }
  .login-box button:disabled { opacity: 0.5; cursor: not-allowed; }
  .login-error {
    color: var(--red); font-size: 13px; margin-top: 12px;
    display: none;
  }

  /* ── Loading Spinner ── */
  .loading-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #FFFFFF; z-index: 1500;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center; gap: 16px;
  }
  .loading-overlay.hidden { display: none; }
  .spinner {
    width: 40px; height: 40px; border-radius: 50%;
    border: 3px solid var(--border); border-top-color: var(--accent);
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text { color: var(--text-muted); font-size: 14px; }

  /* ── Dashboard (hidden until loaded) ── */
  .dashboard-wrap { display: none; }
  .dashboard-wrap.visible { display: block; }

  /* ── Sticky Nav ── */
  .nav {
    position: sticky; top: 0; z-index: 100;
    background: var(--nav-bg); backdrop-filter: blur(16px);
    border-bottom: none;
    padding: 0 24px;
    box-shadow: 0 2px 8px rgba(6,2,55,0.15);
  }
  .nav-inner {
    max-width: 1400px; margin: 0 auto;
    display: flex; align-items: center; gap: 8px;
    height: 52px; overflow-x: auto;
  }
  .nav-tab {
    padding: 8px 16px; border-radius: var(--radius-pill);
    font-size: 13px; font-weight: 500; color: rgba(255,255,255,0.55);
    cursor: pointer; white-space: nowrap;
    transition: all 0.2s;
    text-decoration: none;
  }
  .nav-tab:hover { color: rgba(255,255,255,0.85); background: rgba(255,255,255,0.08); }
  .nav-tab.active { color: #fff; background: var(--accent); }
  .nav-brand {
    font-weight: 700; font-size: 14px; color: var(--accent-light);
    margin-right: 16px; white-space: nowrap;
  }

  /* ── Brand Switcher ── */
  .brand-switcher { position: relative; }
  .brand-btn {
    display: flex; align-items: center; gap: 8px;
    background: none; border: none; cursor: pointer;
    font-family: inherit; padding: 6px 10px; border-radius: var(--radius-pill);
    transition: all 0.15s;
  }
  .brand-btn:hover { background: rgba(255,255,255,0.08); }
  .brand-btn .brand-name {
    font-weight: 700; font-size: 14px; color: #FFFFFF;
    white-space: nowrap;
  }
  .brand-btn .brand-caret {
    font-size: 10px; color: rgba(255,255,255,0.5); transition: transform 0.15s;
  }
  .brand-btn.open .brand-caret { transform: rotate(180deg); }
  .brand-logo {
    width: 22px; height: 22px; border-radius: 6px; object-fit: cover;
    background: var(--bg-card-hover); flex-shrink: 0;
  }
  .brand-logo-placeholder {
    width: 22px; height: 22px; border-radius: 6px;
    background: var(--accent); color: #fff;
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 700; flex-shrink: 0;
  }
  .brand-dd {
    display: none; position: fixed;
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius-lg); box-shadow: 0 12px 40px rgba(6,2,55,0.15);
    z-index: 1000; min-width: 220px; padding: 6px 0;
    overflow: hidden;
  }
  .brand-dd.open { display: block; }
  .brand-option {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 16px; cursor: pointer; transition: all 0.1s;
    border: none; background: none; width: 100%;
    font-family: inherit; text-align: left;
  }
  .brand-option:hover { background: var(--bg-card-hover); }
  .brand-option.active { background: rgba(138,56,245,0.15); }
  .brand-option .bo-name {
    font-size: 13px; font-weight: 500; color: var(--text);
  }
  .brand-option.active .bo-name { color: var(--accent-light); font-weight: 600; }
  .brand-option .bo-meta {
    font-size: 11px; color: var(--text-dim);
  }
  .brand-option .bo-check {
    margin-left: auto; color: var(--accent); font-size: 14px; display: none;
  }
  .brand-option.active .bo-check { display: inline; }
  .nav-right {
    margin-left: auto; display: flex; align-items: center; gap: 12px;
  }
  .refresh-btn {
    background: none; border: 1px solid rgba(255,255,255,0.2); color: rgba(255,255,255,0.6);
    padding: 6px 12px; border-radius: var(--radius-pill); font-size: 12px; cursor: pointer;
    font-family: inherit; display: flex; align-items: center; gap: 6px;
  }
  .refresh-btn:hover { border-color: var(--accent-light); color: #fff; }
  .last-refresh { font-size: 11px; color: rgba(255,255,255,0.4); }
  .logout-btn {
    background: none; border: none; color: rgba(255,255,255,0.4);
    font-size: 12px; cursor: pointer; font-family: inherit;
  }
  .logout-btn:hover { color: var(--red); }

  /* ── Date Picker ── */
  .date-picker-wrap {
    position: relative;
  }
  .date-picker-btn {
    background: var(--bg-card); border: 1px solid var(--border); color: var(--text);
    padding: 6px 14px; border-radius: var(--radius-pill); font-size: 12px; cursor: pointer;
    font-family: inherit; display: flex; align-items: center; gap: 8px;
    white-space: nowrap;
  }
  .date-picker-btn:hover { border-color: var(--accent); }
  .date-picker-btn .dp-icon { font-size: 14px; opacity: 0.6; }
  .date-picker-btn .dp-caret { font-size: 10px; opacity: 0.4; }

  .dp-dropdown {
    display: none; position: fixed;
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius-lg); box-shadow: 0 16px 48px rgba(6,2,55,0.15);
    z-index: 1000; min-width: 520px; overflow: hidden;
  }
  .dp-dropdown.open { display: flex; }

  .dp-presets {
    width: 160px; padding: 12px 0; border-right: 1px solid var(--border);
    flex-shrink: 0;
  }
  .dp-preset {
    display: block; width: 100%; padding: 8px 16px;
    background: none; border: none; color: var(--text-muted);
    font-size: 12px; font-family: inherit; cursor: pointer;
    text-align: left; transition: all 0.15s;
  }
  .dp-preset:hover { background: var(--bg-card-hover); color: var(--text); }
  .dp-preset.active { background: var(--accent); color: #fff; }

  .dp-right {
    flex: 1; padding: 16px; display: flex; flex-direction: column; gap: 12px;
  }
  .dp-tabs {
    display: flex; gap: 0; border-radius: 8px; overflow: hidden;
    border: 1px solid var(--border); width: fit-content;
  }
  .dp-tab-btn {
    padding: 6px 16px; background: none; border: none;
    color: var(--text-muted); font-size: 12px; cursor: pointer; font-family: inherit;
  }
  .dp-tab-btn.active { background: var(--bg-card-hover); color: var(--text); }

  .dp-rolling {
    display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-muted);
  }
  .dp-rolling input {
    width: 64px; padding: 6px 10px; border-radius: 6px;
    background: var(--bg); border: 1px solid var(--border);
    color: var(--text); font-size: 13px; font-family: var(--font-mono);
    text-align: center; outline: none;
  }
  .dp-rolling input:focus { border-color: var(--accent); }
  .dp-rolling select {
    padding: 6px 10px; border-radius: 6px;
    background: var(--bg); border: 1px solid var(--border);
    color: var(--text); font-size: 13px; font-family: inherit;
    outline: none; cursor: pointer;
  }

  .dp-calendars {
    display: flex; gap: 16px;
  }
  .dp-cal {
    flex: 1;
  }
  .dp-cal-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 8px; font-size: 13px; font-weight: 600;
  }
  .dp-cal-nav {
    background: none; border: none; color: var(--text-muted);
    cursor: pointer; font-size: 14px; padding: 4px 8px; border-radius: 4px;
  }
  .dp-cal-nav:hover { color: var(--text); background: var(--bg-card-hover); }
  .dp-cal-grid {
    display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px;
    font-size: 11px;
  }
  .dp-cal-grid .dp-dow {
    text-align: center; color: var(--text-dim); font-weight: 500;
    padding: 4px 0; font-size: 10px;
  }
  .dp-day {
    text-align: center; padding: 5px 2px; border-radius: 6px;
    cursor: pointer; color: var(--text-muted); transition: all 0.1s;
    font-size: 11px;
  }
  .dp-day:hover { background: var(--bg-card-hover); color: var(--text); }
  .dp-day.in-range { background: rgba(138,56,245,0.15); color: var(--text); }
  .dp-day.start, .dp-day.end { background: var(--accent); color: #fff; font-weight: 600; }
  .dp-day.today { border: 1px solid var(--accent); }
  .dp-day.other-month { opacity: 0.3; }
  .dp-day.future { opacity: 0.2; cursor: default; }

  .dp-actions {
    display: flex; justify-content: flex-end; gap: 8px;
    padding-top: 8px; border-top: 1px solid var(--border);
  }
  .dp-action-btn {
    padding: 7px 18px; border-radius: var(--radius-pill); font-size: 12px;
    font-family: inherit; cursor: pointer; font-weight: 500;
  }
  .dp-cancel {
    background: none; border: 1px solid var(--border); color: var(--text-muted);
  }
  .dp-cancel:hover { border-color: var(--text-muted); color: var(--text); }
  .dp-apply {
    background: var(--accent); border: none; color: #fff;
  }
  .dp-apply:hover { background: var(--accent-light); }

  .dp-fixed-row {
    display: none; align-items: center; gap: 8px; font-size: 13px; color: var(--text-muted);
  }
  .dp-fixed-row.active { display: flex; }
  .dp-fixed-input {
    padding: 6px 10px; border-radius: 6px;
    background: var(--bg); border: 1px solid var(--border);
    color: var(--text); font-size: 12px; font-family: var(--font-mono);
    outline: none; width: 120px;
  }
  .dp-fixed-input:focus { border-color: var(--accent); }

  /* ── Hero ── */
  .hero {
    padding: 60px 0 40px;
    text-align: center;
  }
  .hero h1 {
    font-family: var(--font-display);
    font-size: 32px; font-weight: 800; letter-spacing: -0.02em;
    color: var(--primary);
  }
  .hero-sub { color: var(--text-muted); font-size: 14px; margin-top: 8px; }
  .portfolio-badge {
    display: inline-flex; align-items: center; gap: 8px;
    margin-top: 16px; padding: 8px 20px; border-radius: 20px;
    background: var(--bg-card); border: 1px solid var(--border);
    font-size: 14px; font-weight: 600;
  }
  .portfolio-score { font-family: var(--font-mono); font-size: 20px; color: var(--accent); }

  /* ── KPI Cards ── */
  .kpi-grid {
    display: grid; grid-template-columns: repeat(5, 1fr);
    gap: 16px; margin: 24px 0;
  }
  .kpi-card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius-lg); padding: 20px;
    transition: all 0.2s; box-shadow: var(--shadow-sm);
  }
  .kpi-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: var(--shadow-md); }
  .kpi-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); }
  .kpi-val { font-family: var(--font-mono); font-size: 24px; font-weight: 700; margin: 4px 0; }
  .kpi-delta { font-size: 12px; font-weight: 600; }
  .kpi-delta.up { color: var(--green); }
  .kpi-delta.down { color: var(--red); }
  .spark-wrap { position: relative; height: 36px; margin-top: 8px; }
  .kpi-spark { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

  /* ── Phase Summary Bar ── */
  .phase-bar-wrap {
    margin: 24px 0; background: var(--bg-card);
    border: 1px solid var(--border); border-radius: var(--radius-lg);
    padding: 20px; box-shadow: var(--shadow-sm);
  }
  .phase-bar-title { font-size: 13px; font-weight: 600; margin-bottom: 12px; color: var(--text-muted); }
  .phase-bar {
    display: flex; height: 32px; border-radius: 8px; overflow: hidden;
  }
  .phase-seg { display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; color: #fff; min-width: 40px; }
  .phase-legend {
    display: flex; gap: 20px; margin-top: 12px; font-size: 12px; color: var(--text-muted);
  }
  .phase-legend span { display: flex; align-items: center; gap: 6px; }
  .legend-dot { width: 8px; height: 8px; border-radius: 50%; }

  /* ── Chart Section ── */
  .chart-wrap {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius-lg); padding: 24px; margin: 24px 0;
    position: relative; box-shadow: var(--shadow-sm);
  }
  .chart-title { font-size: 15px; font-weight: 600; margin-bottom: 16px; }

  /* ── Section Headers ── */
  .section { padding: 48px 0 24px; }
  .section-header {
    display: flex; align-items: center; gap: 12px;
    margin-bottom: 24px;
  }
  .section-header h2 { font-family: var(--font-display); font-size: 22px; font-weight: 700; letter-spacing: -0.02em; }
  .section-header .section-line { flex: 1; height: 1px; background: var(--border); }

  /* ── Swim Lanes ── */
  .swim-lane { margin-bottom: 28px; }
  .lane-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 12px; padding: 0 4px;
  }
  .lane-title { display: flex; align-items: center; gap: 10px; }
  .lane-dot { width: 10px; height: 10px; border-radius: 50%; }
  .lane-name { font-size: 16px; font-weight: 700; }
  .lane-count { font-size: 12px; color: var(--text-muted); background: var(--bg-card); padding: 2px 10px; border-radius: 10px; }
  .lane-stats { display: flex; gap: 20px; font-size: 13px; color: var(--text-muted); }
  .lane-stats b { color: var(--text); }
  .lane-scroll {
    display: flex; gap: 16px; overflow-x: auto;
    scroll-snap-type: x mandatory; padding-bottom: 12px;
    -webkit-overflow-scrolling: touch;
  }
  .lane-scroll::-webkit-scrollbar { height: 4px; }
  .lane-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  /* ── Creative Cards ── */
  .creative-card {
    flex: 0 0 340px; scroll-snap-align: start;
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius-lg); overflow: hidden;
    transition: all 0.2s; cursor: pointer;
    box-shadow: var(--shadow-sm);
    display: flex; flex-direction: row;
    height: 260px;
  }
  .creative-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: var(--shadow-md); }
  .card-thumb {
    width: 150px; min-width: 150px; height: 100%;
    background: #F5F5F5; overflow: hidden;
    position: relative; flex-shrink: 0;
  }
  .card-thumb img { width: 100%; height: 100%; object-fit: cover; image-rendering: auto; }
  .card-thumb .video-badge {
    position: absolute; bottom: 8px; left: 8px;
    background: rgba(0,0,0,0.7); color: #fff;
    padding: 2px 8px; border-radius: var(--radius-pill);
    font-size: 10px; font-weight: 600;
    display: flex; align-items: center; gap: 4px;
  }
  .card-body { padding: 14px; flex: 1; display: flex; flex-direction: column; min-width: 0; overflow: hidden; }
  .card-badges { display: flex; gap: 6px; margin-bottom: 8px; flex-wrap: wrap; }
  .badge {
    font-size: 10px; font-weight: 600; padding: 2px 8px;
    border-radius: var(--radius-pill); text-transform: uppercase; letter-spacing: 0.5px;
  }
  .card-name {
    font-size: 12px; font-weight: 600; color: var(--text);
    overflow: hidden; text-overflow: ellipsis;
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
    margin-bottom: 8px; line-height: 1.4;
  }
  .card-metrics { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 10px; }
  .cm { display: flex; flex-direction: column; }
  .cm-label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }
  .cm-val { font-family: var(--font-mono); font-size: 13px; font-weight: 600; }
  .card-footer { display: flex; align-items: center; gap: 8px; margin-top: auto; }
  .health-bar-mini { flex: 1; height: 4px; background: var(--border); border-radius: 4px; overflow: hidden; }
  .health-fill { height: 100%; border-radius: 4px; transition: width 0.3s; }
  .action-badge {
    font-size: 10px; font-weight: 700; padding: 3px 8px;
    border-radius: var(--radius-pill); letter-spacing: 0.5px;
  }

  /* ── Table ── */
  .filter-bar {
    display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;
  }
  .filter-bar input, .filter-bar select {
    background: var(--bg-card); border: 1px solid var(--border);
    color: var(--text); padding: 8px 14px; border-radius: 8px;
    font-size: 13px; font-family: inherit;
  }
  .filter-bar input { flex: 1; min-width: 200px; }
  .filter-bar select { min-width: 130px; }
  .filter-count { font-size: 12px; color: var(--text-muted); margin-left: auto; }

  .data-table-wrap {
    overflow-x: auto; border-radius: var(--radius-lg);
    border: 1px solid var(--border);
    max-height: 75vh; overflow-y: auto;
    box-shadow: var(--shadow-sm); background: var(--bg-card);
  }
  .data-table {
    width: 100%; border-collapse: collapse;
    font-size: 13px;
  }
  .data-table th {
    background: var(--bg-card-hover); padding: 12px 14px;
    text-align: left; font-size: 11px; text-transform: uppercase;
    letter-spacing: 0.5px; color: var(--text-muted); font-weight: 600;
    cursor: pointer; white-space: nowrap; position: sticky; top: 0;
    user-select: none;
  }
  .data-table th:hover { color: var(--text); }
  .data-table th .sort-icon { margin-left: 4px; opacity: 0.3; }
  .data-table th.sorted .sort-icon { opacity: 1; }
  .data-table td {
    padding: 8px 12px; border-top: 1px solid var(--border);
    white-space: nowrap; vertical-align: middle;
  }
  .data-table tr:hover td { background: var(--bg-card-hover); }
  .data-table tr { transition: background 0.15s; }
  .td-creative { min-width: 300px; white-space: normal; }
  .creative-cell { display: flex; align-items: center; gap: 10px; }
  .creative-cell img { flex-shrink: 0; }
  .table-thumb {
    width: 48px; height: 72px; border-radius: 6px; object-fit: cover;
    flex-shrink: 0; background: var(--border);
  }
  .creative-info { display: flex; flex-direction: column; gap: 2px; min-width: 0; }
  .data-table .table-name {
    font-weight: 500; overflow: hidden; text-overflow: ellipsis;
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
    white-space: normal; max-width: 280px; line-height: 1.35; font-size: 12px;
  }
  .table-sub { font-size: 10px; color: var(--text-muted); display: flex; align-items: center; gap: 4px; }
  .thumb-placeholder { width: 48px; height: 72px; border-radius: 6px; background: var(--border); display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
  .td-num { font-family: var(--font-mono), monospace; font-size: 12px; }
  .badge-sm {
    font-size: 10px; font-weight: 600; padding: 2px 7px;
    border-radius: 4px;
  }
  .action-badge-sm {
    font-size: 10px; font-weight: 700; padding: 2px 7px;
    border-radius: 4px; letter-spacing: 0.5px;
  }
  .health-bar-table { display: inline-block; width: 50px; height: 4px; background: var(--border); border-radius: 4px; vertical-align: middle; margin-right: 6px; overflow: hidden; }
  .health-num { font-family: var(--font-mono); font-size: 11px; color: var(--text-muted); }

  /* ── Breakdowns ── */
  .breakdown-tabs {
    display: flex; gap: 4px; margin-bottom: 20px;
    background: var(--bg); border-radius: var(--radius-pill);
    padding: 4px; width: fit-content; border: 1px solid var(--border);
  }
  .breakdown-tab {
    padding: 8px 18px; border-radius: var(--radius-pill);
    font-size: 13px; font-weight: 500; cursor: pointer;
    color: var(--text-muted); transition: all 0.2s; border: none; background: none;
    font-family: inherit;
  }
  .breakdown-tab:hover { color: var(--text); background: rgba(138,56,245,0.05); }
  .breakdown-tab.active { background: var(--accent); color: #fff; font-weight: 600; }
  .breakdown-panel { display: none; }
  .breakdown-panel.active { display: block; }
  .bd-table-wrap {
    overflow-x: auto; border-radius: var(--radius-lg);
    border: 1px solid var(--border); box-shadow: var(--shadow-sm);
    background: var(--bg-card);
  }
  .bd-table {
    width: 100%; border-collapse: collapse; font-size: 13px;
  }
  .bd-table th {
    background: var(--bg-card-hover); padding: 10px 14px;
    text-align: left; font-size: 11px; text-transform: uppercase;
    letter-spacing: 0.5px; color: var(--text-muted); font-weight: 600;
    white-space: nowrap; position: sticky; top: 0;
  }
  .bd-table td {
    padding: 10px 14px; border-top: 1px solid var(--border);
    white-space: nowrap; vertical-align: middle;
  }
  .bd-table tr:hover td { background: var(--bg-card-hover); }
  .bd-table .td-name { white-space: normal; max-width: 300px; font-weight: 500; }
  .bd-table .td-num { font-family: var(--font-mono); font-size: 12px; text-align: right; }
  .bd-table .td-num-left { font-family: var(--font-mono); font-size: 12px; }
  .funnel-badge {
    font-size: 10px; font-weight: 700; padding: 2px 8px;
    border-radius: var(--radius-pill); letter-spacing: 0.3px;
  }
  .funnel-badge.tof { background: rgba(37,99,235,0.1); color: #2563EB; }
  .funnel-badge.mof { background: rgba(138,56,245,0.1); color: #8A38F5; }
  .funnel-badge.bof { background: rgba(22,163,74,0.1); color: #16A34A; }
  .funnel-badge.mof-bof { background: rgba(234,88,12,0.1); color: #EA580C; }
  .funnel-badge.other { background: rgba(107,114,128,0.1); color: #6B7280; }
  .bd-expand-row { cursor: pointer; }
  .bd-expand-row:hover td { background: rgba(138,56,245,0.03); }
  .bd-expand-icon { font-size: 10px; color: var(--text-dim); margin-right: 6px; transition: transform 0.2s; display: inline-block; }
  .bd-expand-icon.open { transform: rotate(90deg); }
  .bd-child-row td { background: rgba(138,56,245,0.02); }
  .bd-child-row td:first-child { padding-left: 36px; }
  .bd-child-row.hidden { display: none; }
  .bd-summary-row td { font-weight: 600; background: var(--bg-card-hover); border-top: 2px solid var(--border); }
  .bd-share-bar {
    display: inline-block; width: 60px; height: 6px; background: var(--border);
    border-radius: 3px; vertical-align: middle; overflow: hidden;
  }
  .bd-share-fill { height: 100%; border-radius: 3px; background: var(--accent); }
  .trend-arrow { font-size: 11px; margin-left: 2px; }
  .trend-arrow.up { color: var(--green); }
  .trend-arrow.down { color: var(--red); }
  .trend-arrow.flat { color: var(--text-dim); }

  /* ── Funnel ── */
  .funnel-wrap {
    display: grid; grid-template-columns: 1fr 1fr; gap: 24px;
  }
  .funnel-steps { display: flex; flex-direction: column; gap: 8px; }
  .funnel-step { display: flex; align-items: center; gap: 16px; }
  .funnel-bar-wrap { flex: 1; height: 36px; background: var(--border); border-radius: 6px; overflow: hidden; }
  .funnel-bar {
    height: 100%; border-radius: 6px;
    background: linear-gradient(90deg, var(--accent), var(--purple));
    transition: width 0.6s ease;
  }
  .funnel-info { min-width: 200px; display: flex; align-items: center; gap: 10px; }
  .funnel-label { font-size: 12px; color: var(--text-muted); min-width: 130px; }
  .funnel-val { font-family: var(--font-mono); font-size: 14px; font-weight: 600; }
  .funnel-conv {
    font-size: 11px; font-weight: 600; color: var(--accent-light);
    background: var(--accent)15; padding: 2px 6px; border-radius: 4px;
  }
  .funnel-health {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius-lg); padding: 24px; box-shadow: var(--shadow-sm);
  }
  .funnel-health h3 { font-size: 15px; font-weight: 600; margin-bottom: 16px; }
  .leak-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: 8px 0; border-bottom: 1px solid var(--border);
    font-size: 13px;
  }
  .leak-rate { font-family: var(--font-mono); font-weight: 600; }
  .worst-leak {
    margin-top: 16px; padding: 12px 16px; border-radius: 8px;
    background: var(--red-dim); border: 1px solid var(--red)40;
    font-size: 13px;
  }

  /* ── Audience Segments ── */
  .audience-tabs { display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; }
  .audience-tab {
    padding: 8px 16px; border-radius: var(--radius-pill); border: 1px solid var(--border);
    background: var(--bg-card); color: var(--text-muted); cursor: pointer;
    font-size: 13px; font-family: inherit; transition: all 0.15s;
  }
  .audience-tab:hover { border-color: var(--accent); color: var(--text); }
  .audience-tab.active { background: var(--accent); color: #fff; border-color: var(--accent); }
  .audience-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px; }
  .segment-card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius-lg); padding: 20px; transition: all 0.2s;
    box-shadow: var(--shadow-sm);
  }
  .segment-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: var(--shadow-md); }
  .segment-name { font-size: 15px; font-weight: 700; margin-bottom: 4px; text-transform: capitalize; }
  .segment-share { font-size: 11px; color: var(--text-muted); margin-bottom: 12px; }
  .segment-bar-wrap { height: 6px; background: var(--border); border-radius: 3px; margin-bottom: 16px; overflow: hidden; }
  .segment-bar { height: 100%; border-radius: 3px; transition: width 0.4s ease; }
  .segment-metrics { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .segment-metric-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 2px; }
  .segment-metric-value { font-family: var(--font-mono), monospace; font-size: 15px; font-weight: 600; }

  /* ── Alerts ── */
  .alerts-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 16px; }
  .alert-card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius-lg); padding: 20px;
    transition: all 0.2s; box-shadow: var(--shadow-sm);
  }
  .alert-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
  .alert-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
  .alert-icon { font-size: 20px; }
  .alert-title { font-size: 15px; font-weight: 700; }
  .alert-desc { font-size: 13px; color: var(--text-muted); margin-bottom: 12px; line-height: 1.5; }
  .alert-action {
    font-size: 12px; font-weight: 600; color: var(--accent-light);
    padding: 8px 12px; background: var(--accent)10; border-radius: 8px;
  }

  /* ── Footer ── */
  .footer {
    text-align: center; padding: 40px 0; margin-top: 40px;
    border-top: 1px solid var(--border);
    font-size: 12px; color: var(--text-dim);
  }

  /* ── BOCO Component System ── */
  .boco-btn {
    display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    padding: 10px 24px; border-radius: var(--radius-pill);
    font-family: var(--font-body); font-size: 14px; font-weight: 600;
    cursor: pointer; transition: all 0.2s; border: none;
    background: var(--accent); color: #fff;
  }
  .boco-btn:hover { background: var(--accent-light); box-shadow: var(--shadow-glow); }
  .boco-btn--ghost {
    background: transparent; color: var(--accent);
    border: 1px solid var(--border);
  }
  .boco-btn--ghost:hover { border-color: var(--accent); background: var(--accent-dim); box-shadow: none; }
  .boco-btn--sm { padding: 6px 16px; font-size: 12px; }

  .boco-card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius-lg); padding: 20px;
    box-shadow: var(--shadow-sm); transition: all 0.2s;
  }
  .boco-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: var(--shadow-md); }

  .boco-badge {
    display: inline-flex; align-items: center; gap: 4px;
    font-size: 10px; font-weight: 600; padding: 2px 10px;
    border-radius: var(--radius-pill); text-transform: uppercase; letter-spacing: 0.5px;
  }

  .boco-tab {
    padding: 8px 16px; border-radius: var(--radius-pill);
    border: 1px solid var(--border); background: var(--bg-card);
    color: var(--text-muted); cursor: pointer;
    font-size: 13px; font-family: var(--font-body); font-weight: 500;
    transition: all 0.15s;
  }
  .boco-tab:hover { border-color: var(--accent); color: var(--text); }
  .boco-tab.active { background: var(--accent); color: #fff; border-color: var(--accent); }

  .boco-label {
    font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em;
    color: var(--text-muted); font-weight: 500;
  }

  .boco-value {
    font-family: var(--font-mono); font-weight: 600;
  }

  .boco-section {
    padding: 48px 0 24px;
  }

  .boco-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;
  }

  /* ── Responsive ── */
  @media (max-width: 768px) {
    .kpi-grid { grid-template-columns: repeat(2, 1fr); }
    .funnel-wrap { grid-template-columns: 1fr; }
    .creative-card { flex: 0 0 280px; flex-direction: column; height: auto; }
    .card-thumb { width: 100%; min-width: unset; height: 180px; }
  }

  /* ── Animations ── */
  .fade-in {
    opacity: 0; transform: translateY(20px);
    transition: opacity 0.5s, transform 0.5s;
  }
  .fade-in.visible { opacity: 1; transform: translateY(0); }

  /* ── Creative Detail Modal ── */
  .modal-overlay {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(6,2,55,0.6); z-index: 1000; align-items: center; justify-content: center;
    backdrop-filter: blur(8px);
  }
  .modal-overlay.active { display: flex; }
  .modal {
    background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px;
    max-width: 960px; width: 95%; max-height: 92vh; overflow-y: auto;
    display: grid; grid-template-columns: 1fr 1fr; gap: 0;
  }
  .modal.modal-vertical {
    max-width: 1060px; grid-template-columns: 420px 1fr;
    height: 88vh; max-height: 88vh; overflow-y: hidden;
  }
  .modal.modal-vertical .modal-media { min-height: unset; height: 100%; }
  .modal.modal-vertical .modal-media iframe { height: 100% !important; min-height: unset !important; }
  .modal.modal-vertical .modal-details { max-height: 88vh; }
  .modal-media {
    background: #000; border-radius: 16px 0 0 16px; display: flex;
    align-items: center; justify-content: center; min-height: 400px;
    position: relative; overflow: hidden;
  }
  .modal-media img { max-width: 100%; max-height: 85vh; object-fit: contain; }
  .modal-media video { max-width: 100%; max-height: 85vh; object-fit: contain; border-radius: 8px; }
  .modal-video-wrap { position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
  .modal-video-wrap video { width: 100%; height: 100%; object-fit: contain; }
  .video-play-overlay {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 64px; height: 64px; background: rgba(138,56,245,0.9); border-radius: 50%;
    display: flex; align-items: center; justify-content: center; cursor: pointer;
    transition: all 0.2s; z-index: 2;
  }
  .video-play-overlay:hover { background: rgba(138,56,245,1); transform: translate(-50%, -50%) scale(1.1); }
  .video-play-overlay svg { margin-left: 4px; }
  .video-play-overlay.hidden { display: none; }
  .video-meta-badge {
    position: absolute; bottom: 12px; left: 12px; background: rgba(0,0,0,0.7); color: #fff;
    padding: 4px 12px; border-radius: var(--radius-pill); font-size: 11px; font-weight: 600;
    display: flex; align-items: center; gap: 6px; z-index: 2;
  }
  .video-fb-link {
    position: absolute; bottom: 12px; right: 12px; background: rgba(138,56,245,0.9); color: #fff;
    padding: 6px 12px; border-radius: var(--radius-pill); font-size: 11px; font-weight: 600;
    text-decoration: none; z-index: 2; transition: background 0.2s;
  }
  .video-fb-link:hover { background: rgba(138,56,245,1); }
  .modal-details { padding: 28px; overflow-y: auto; max-height: 90vh; }
  .modal-close {
    position: absolute; top: 12px; right: 12px; width: 36px; height: 36px;
    background: rgba(0,0,0,0.6); border: none; color: #fff; border-radius: 50%;
    font-size: 18px; cursor: pointer; z-index: 1001; display: flex;
    align-items: center; justify-content: center;
  }
  .modal-close:hover { background: rgba(255,255,255,0.2); }
  .modal-title { font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 16px; line-height: 1.4; }
  .modal-badges { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
  .modal-section { margin-bottom: 20px; }
  .modal-section-title { font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
  .modal-metrics { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .modal-metric { background: var(--bg); border-radius: 8px; padding: 12px; }
  .modal-metric .label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; }
  .modal-metric .value { font-size: 18px; font-weight: 700; color: var(--text); margin-top: 2px; }
  .modal-metric .sub { font-size: 11px; color: var(--text-muted); }
  .modal-adcopy { font-size: 13px; color: var(--text); line-height: 1.6; white-space: pre-wrap; max-height: 200px; overflow-y: auto; background: var(--bg); border-radius: 8px; padding: 12px; }
  .modal-actions { display: flex; gap: 8px; margin-top: 16px; }
  .modal-btn {
    padding: 8px 16px; border-radius: var(--radius-pill); font-size: 12px; font-weight: 600;
    cursor: pointer; border: 1px solid var(--border); background: var(--bg);
    color: var(--text); text-decoration: none; display: inline-flex; align-items: center; gap: 6px;
  }
  .modal-btn:hover { border-color: var(--accent); color: var(--accent); }
  .modal-btn.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
  @media (max-width: 768px) {
    .modal, .modal.modal-vertical { grid-template-columns: 1fr; max-width: 95%; height: auto; max-height: 90vh; overflow-y: auto; }
    .modal-media { border-radius: 16px 16px 0 0; min-height: 250px; }
    .modal.modal-vertical .modal-media { height: 60vh; }
  }
</style>
</head>
<body>

<!-- Login Screen -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-box">
    <h2>Varalife Creative Hub</h2>
    <p class="login-sub">Sign in to access your creative dashboard</p>
    <input type="email" id="loginEmail" placeholder="Email" autocomplete="email">
    <input type="password" id="loginPassword" placeholder="Password" autocomplete="current-password">
    <button id="loginBtn" onclick="handleLogin()">Sign In</button>
    <div class="login-error" id="loginError"></div>
  </div>
</div>

<!-- Loading Spinner -->
<div class="loading-overlay hidden" id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text">Loading creative data...</div>
</div>

<!-- Dashboard (hidden until authenticated + data loaded) -->
<div class="dashboard-wrap" id="dashboardWrap">

<!-- Nav -->
<nav class="nav">
  <div class="nav-inner">
    <div class="brand-switcher" id="brandSwitcher">
      <button class="brand-btn" id="brandBtn" onclick="toggleBrandPicker()">
        <span class="brand-logo-placeholder" id="brandLogo">V</span>
        <span class="brand-name" id="brandName">Loading...</span>
        <span class="brand-caret">&#9662;</span>
      </button>
      <div class="brand-dd" id="brandDropdown"></div>
    </div>
    <a href="#overview" class="nav-tab" onclick="scrollTo_(event,'overview')">Overview</a>
    <a href="#swimlanes" class="nav-tab" onclick="scrollTo_(event,'swimlanes')">Swim Lanes</a>
    <a href="#breakdowns" class="nav-tab" onclick="scrollTo_(event,'breakdowns')">Breakdowns</a>
    <a href="#table" class="nav-tab active" onclick="scrollTo_(event,'table')">Table</a>
    <a href="#funnel" class="nav-tab" onclick="scrollTo_(event,'funnel')">Funnel</a>
    <a href="#audience" class="nav-tab" onclick="scrollTo_(event,'audience')">Audience</a>
    <a href="#alerts" class="nav-tab" onclick="scrollTo_(event,'alerts')">Alerts</a>
    <div class="nav-right">
      <div class="date-picker-wrap" id="datePickerWrap">
        <button class="date-picker-btn" onclick="toggleDatePicker()">
          <span class="dp-icon">&#128197;</span>
          <span id="dpLabel">Last 14 days</span>
          <span class="dp-caret">&#9662;</span>
        </button>
        <div class="dp-dropdown" id="dpDropdown">
          <div class="dp-presets" id="dpPresets"></div>
          <div class="dp-right">
            <div class="dp-tabs">
              <button class="dp-tab-btn active" data-tab="rolling" onclick="setDpTab('rolling')">Rolling</button>
              <button class="dp-tab-btn" data-tab="fixed" onclick="setDpTab('fixed')">Fixed</button>
            </div>
            <div class="dp-rolling" id="dpRolling">
              <span>Last</span>
              <input type="number" id="dpRollingVal" value="14" min="1" max="365">
              <select id="dpRollingUnit">
                <option value="days">Days</option>
                <option value="months">Months</option>
              </select>
            </div>
            <div class="dp-fixed-row" id="dpFixed">
              <span>From</span>
              <input type="date" class="dp-fixed-input" id="dpStartDate">
              <span>to</span>
              <input type="date" class="dp-fixed-input" id="dpEndDate">
            </div>
            <div class="dp-calendars" id="dpCalendars"></div>
            <div class="dp-actions">
              <button class="dp-action-btn dp-cancel" onclick="closeDatePicker()">Cancel</button>
              <button class="dp-action-btn dp-apply" onclick="applyDatePicker()">Apply</button>
            </div>
          </div>
        </div>
      </div>
      <span class="last-refresh" id="lastRefresh"></span>
      <button class="refresh-btn" onclick="refreshDashboard()">&#8635; Refresh</button>
      <button class="logout-btn" onclick="handleLogout()">Sign out</button>
    </div>
  </div>
</nav>

<!-- Hero + KPIs -->
<section id="overview" class="section">
<div class="container">
  <div class="hero">
    <h1>Creative Performance Dashboard</h1>
    <p class="hero-sub" id="heroSub">Loading...</p>
    <div class="portfolio-badge">
      Portfolio Health <span class="portfolio-score" id="portfolioScore">--</span>
    </div>
  </div>

  <div class="kpi-grid" id="kpiGrid"></div>

  <div class="phase-bar-wrap fade-in" id="phaseBarWrap"></div>

  <div class="chart-wrap fade-in">
    <div class="chart-title">Daily Spend &amp; ROAS (30 days)</div>
    <div style="position:relative;height:300px">
      <canvas id="chart-daily"></canvas>
    </div>
  </div>
</div>
</section>

<!-- Swim Lanes -->
<section id="swimlanes" class="section">
<div class="container">
  <div class="section-header fade-in">
    <h2>Lifecycle Swim Lanes</h2>
    <div class="section-line"></div>
  </div>
  <div id="swimLanesContainer"></div>
</div>
</section>

<!-- Breakdowns -->
<section id="breakdowns" class="section">
<div class="container">
  <div class="section-header fade-in">
    <h2>Campaign & Ad Set Breakdowns</h2>
    <div class="section-line"></div>
  </div>

  <div class="breakdown-tabs fade-in">
    <button class="breakdown-tab active" onclick="switchBreakdown('campaign')">Campaign</button>
    <button class="breakdown-tab" onclick="switchBreakdown('adset')">Ad Set</button>
    <button class="breakdown-tab" onclick="switchBreakdown('product')">Product</button>
    <button class="breakdown-tab" onclick="switchBreakdown('format')">Format</button>
  </div>

  <div id="bd-campaign" class="breakdown-panel active"></div>
  <div id="bd-adset" class="breakdown-panel"></div>
  <div id="bd-product" class="breakdown-panel"></div>
  <div id="bd-format" class="breakdown-panel"></div>
</div>
</section>

<!-- Table -->
<section id="table" class="section">
<div class="container">
  <div class="section-header fade-in">
    <h2>All Creatives</h2>
    <div class="section-line"></div>
  </div>

  <div class="filter-bar fade-in">
    <input type="text" id="filter-search" placeholder="Search creatives..." oninput="filterTable()">
    <select id="filter-phase" onchange="filterTable()">
      <option value="">All Phases</option>
      <option value="scaling">Scaling</option>
      <option value="peak">Peak</option>
      <option value="learning">Learning</option>
      <option value="declining">Declining</option>
    </select>
    <select id="filter-product" onchange="filterTable()">
      <option value="">All Products</option>
      <option value="varapace">Varapace</option>
      <option value="varaspan">Varaspan</option>
      <option value="varacare">VaraCare</option>
    </select>
    <select id="filter-format" onchange="filterTable()">
      <option value="">All Formats</option>
      <option value="video">Video</option>
      <option value="image">Image</option>
      <option value="carousel">Carousel</option>
    </select>
    <select id="filter-action" onchange="filterTable()">
      <option value="">All Actions</option>
      <option value="scale">SCALE</option>
      <option value="maintain">MAINTAIN</option>
      <option value="watch">WATCH</option>
      <option value="kill">KILL</option>
      <option value="test">TEST</option>
      <option value="monitor">MONITOR</option>
    </select>
    <span class="filter-count"><span id="row-count">0</span></span>
  </div>

  <div class="data-table-wrap fade-in">
    <table class="data-table" id="creative-table">
      <thead>
        <tr>
          <th onclick="sortTable(0)">Creative <span class="sort-icon">&#8597;</span></th>
          <th onclick="sortTable(1)">Product <span class="sort-icon">&#8597;</span></th>
          <th onclick="sortTable(2)">Phase <span class="sort-icon">&#8597;</span></th>
          <th onclick="sortTable(3)">Spend <span class="sort-icon">&#8597;</span></th>
          <th onclick="sortTable(4)">7d Spend <span class="sort-icon">&#8597;</span></th>
          <th onclick="sortTable(5)">ROAS <span class="sort-icon">&#8597;</span></th>
          <th onclick="sortTable(6)">7d ROAS <span class="sort-icon">&#8597;</span></th>
          <th onclick="sortTable(7)">CPP <span class="sort-icon">&#8597;</span></th>
          <th onclick="sortTable(8)">CTR <span class="sort-icon">&#8597;</span></th>
          <th onclick="sortTable(9)">Days <span class="sort-icon">&#8597;</span></th>
          <th onclick="sortTable(10)">Health <span class="sort-icon">&#8597;</span></th>
          <th onclick="sortTable(11)">Action <span class="sort-icon">&#8597;</span></th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
</div>
</section>

<!-- Funnel -->
<section id="funnel" class="section">
<div class="container">
  <div class="section-header fade-in">
    <h2>Conversion Funnels</h2>
    <div class="section-line"></div>
  </div>
  <div class="breakdown-tabs fade-in" id="funnelTabs">
    <button class="breakdown-tab active" onclick="switchFunnelTab(this,'all')">All Products</button>
  </div>
  <div class="funnel-wrap fade-in" id="funnelWrap"></div>
  <div id="productFunnelWrap" class="fade-in" style="margin-top:32px"></div>
</div>
</section>

<!-- Audience Segments -->
<section id="audience" class="section">
<div class="container">
  <div class="section-header fade-in">
    <h2>Audience Segments</h2>
    <div class="section-line"></div>
  </div>
  <div class="audience-tabs fade-in" id="audienceTabs">
    <button class="audience-tab active" onclick="switchAudienceTab(this,'age')">Age</button>
    <button class="audience-tab" onclick="switchAudienceTab(this,'gender')">Gender</button>
    <button class="audience-tab" onclick="switchAudienceTab(this,'publisher_platform')">Platform</button>
    <button class="audience-tab" onclick="switchAudienceTab(this,'device_platform')">Device</button>
    <button class="audience-tab" onclick="switchAudienceTab(this,'country')">Country</button>
  </div>
  <div id="audienceContainer" class="fade-in"></div>
</div>
</section>

<!-- Alerts -->
<section id="alerts" class="section">
<div class="container">
  <div class="section-header fade-in">
    <h2>Alerts &amp; Recommendations</h2>
    <div class="section-line"></div>
  </div>
  <div class="alerts-grid" id="alertsGrid"></div>
</div>
</section>

<!-- Footer -->
<div class="footer" id="dashboardFooter"></div>

</div><!-- end dashboard-wrap -->

<!-- Creative Detail Modal -->
<div class="modal-overlay" id="creativeModal" onclick="if(event.target===this)closeCreativeModal()">
  <div class="modal">
    <button class="modal-close" onclick="closeCreativeModal()">&#10005;</button>
    <div class="modal-media" id="modalMedia"></div>
    <div class="modal-details" id="modalDetails"></div>
  </div>
</div>

<script>
// Prevent browser scroll restoration
if ('scrollRestoration' in history) history.scrollRestoration = 'manual';
window.scrollTo(0, 0);

// ── Config ──
const SUPABASE_URL = 'https://dyktmiyvpnayqwwlqspe.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5a3RtaXl2cG5heXF3d2xxc3BlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1OTUxOTIsImV4cCI6MjA4NzE3MTE5Mn0.2Ij_ZJs_VJPFhy81Vm_bm6J8RCjI3t4rKICAr00IRYs';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let DATA = { daily: [], creatives: [], actionColors: {}, phaseColors: {} };
let currentWorkspace = null;
let allWorkspaces = [];

// ── Date Picker State ──
let dpMode = 'rolling'; // 'rolling' or 'fixed'
let dpDays = 14;
let dpStartDate = null;
let dpEndDate = null;
let dpSelecting = null; // null, 'start', 'end'
let dpCalMonth1 = null; // Date for left calendar
let dpCalMonth2 = null; // Date for right calendar
let dpTempStart = null;
let dpTempEnd = null;

const DP_PRESETS = [
  { label: 'Last 7 days', days: 7 },
  { label: 'Last 14 days', days: 14 },
  { label: 'Last 30 days', days: 30 },
  { label: 'Last 60 days', days: 60 },
  { label: 'Last 90 days', days: 90 },
  { label: 'Last 12 months', days: 365 },
];

function initDatePicker() {
  const presets = document.getElementById('dpPresets');
  presets.innerHTML = DP_PRESETS.map((p, i) =>
    `<button class="dp-preset${p.days === dpDays ? ' active' : ''}" data-days="${p.days}" onclick="selectPreset(${p.days})">${p.label}</button>`
  ).join('');

  const now = new Date();
  dpCalMonth2 = new Date(now.getFullYear(), now.getMonth(), 1);
  dpCalMonth1 = new Date(now.getFullYear(), now.getMonth() - 1, 1);

  // Set fixed date inputs
  const end = new Date();
  const start = new Date();
  start.setDate(start.getDate() - dpDays);
  document.getElementById('dpStartDate').value = fmtDateInput(start);
  document.getElementById('dpEndDate').value = fmtDateInput(end);
  document.getElementById('dpEndDate').max = fmtDateInput(end);

  renderCalendars();
}

function fmtDateInput(d) {
  return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
}

function fmtDateLabel(d) {
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return months[d.getMonth()] + ' ' + d.getDate() + ', ' + d.getFullYear();
}

function toggleDatePicker() {
  const dd = document.getElementById('dpDropdown');
  if (dd.classList.contains('open')) { closeDatePicker(); return; }
  // Position dropdown below button using fixed positioning
  const btn = document.querySelector('.date-picker-btn');
  const rect = btn.getBoundingClientRect();
  dd.style.top = (rect.bottom + 8) + 'px';
  dd.style.right = (window.innerWidth - rect.right) + 'px';
  dd.classList.add('open');
  initDatePicker();
  // Close on outside click
  setTimeout(() => document.addEventListener('click', closeDpOutside), 10);
}

function closeDatePicker() {
  document.getElementById('dpDropdown').classList.remove('open');
  document.removeEventListener('click', closeDpOutside);
}

function closeDpOutside(e) {
  if (!document.getElementById('datePickerWrap').contains(e.target)) closeDatePicker();
}

function setDpTab(tab) {
  dpMode = tab;
  document.querySelectorAll('.dp-tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
  document.getElementById('dpRolling').style.display = tab === 'rolling' ? 'flex' : 'none';
  const fixedRow = document.getElementById('dpFixed');
  fixedRow.classList.toggle('active', tab === 'fixed');
  if (tab === 'fixed') {
    // Init temp dates from current selection
    const end = new Date();
    const start = new Date(); start.setDate(start.getDate() - dpDays);
    dpTempStart = start; dpTempEnd = end;
    document.getElementById('dpStartDate').value = fmtDateInput(start);
    document.getElementById('dpEndDate').value = fmtDateInput(end);
    renderCalendars();
  }
}

function selectPreset(days) {
  dpMode = 'rolling';
  dpDays = days;
  document.querySelectorAll('.dp-preset').forEach(b => b.classList.toggle('active', Number(b.dataset.days) === days));
  document.getElementById('dpRollingVal').value = days;
  document.getElementById('dpRollingUnit').value = 'days';
  setDpTab('rolling');
  // Auto-apply preset
  applyDatePicker();
}

function renderCalendars() {
  const wrap = document.getElementById('dpCalendars');
  if (dpMode !== 'fixed') { wrap.innerHTML = ''; return; }

  const today = new Date(); today.setHours(0,0,0,0);

  function renderMonth(date, showPrev, showNext) {
    const year = date.getFullYear(), month = date.getMonth();
    const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    const firstDay = new Date(year, month, 1).getDay(); // 0=Sun
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    let html = `<div class="dp-cal">
      <div class="dp-cal-header">
        ${showPrev ? `<button class="dp-cal-nav" onclick="shiftCal(-1)">&#8592;</button>` : '<span></span>'}
        <span>${months[month]} ${year}</span>
        ${showNext ? `<button class="dp-cal-nav" onclick="shiftCal(1)">&#8594;</button>` : '<span></span>'}
      </div>
      <div class="dp-cal-grid">
        <div class="dp-dow">Su</div><div class="dp-dow">Mo</div><div class="dp-dow">Tu</div>
        <div class="dp-dow">We</div><div class="dp-dow">Th</div><div class="dp-dow">Fr</div><div class="dp-dow">Sa</div>`;

    // Blanks for days before 1st
    for (let i = 0; i < firstDay; i++) html += `<div class="dp-day other-month"></div>`;

    for (let d = 1; d <= daysInMonth; d++) {
      const dt = new Date(year, month, d);
      let cls = 'dp-day';
      if (dt > today) cls += ' future';
      if (dt.toDateString() === today.toDateString()) cls += ' today';
      if (dpTempStart && dt.toDateString() === dpTempStart.toDateString()) cls += ' start';
      if (dpTempEnd && dt.toDateString() === dpTempEnd.toDateString()) cls += ' end';
      if (dpTempStart && dpTempEnd && dt > dpTempStart && dt < dpTempEnd) cls += ' in-range';
      const clickable = dt <= today;
      html += `<div class="${cls}" ${clickable ? `onclick="pickDay(${year},${month},${d})"` : ''}>${d}</div>`;
    }
    html += '</div></div>';
    return html;
  }

  wrap.innerHTML = renderMonth(dpCalMonth1, true, false) + renderMonth(dpCalMonth2, false, true);
}

function shiftCal(dir) {
  dpCalMonth1 = new Date(dpCalMonth1.getFullYear(), dpCalMonth1.getMonth() + dir, 1);
  dpCalMonth2 = new Date(dpCalMonth1.getFullYear(), dpCalMonth1.getMonth() + 1, 1);
  renderCalendars();
}

function pickDay(y, m, d) {
  const dt = new Date(y, m, d);
  if (!dpTempStart || (dpTempStart && dpTempEnd)) {
    dpTempStart = dt; dpTempEnd = null;
  } else {
    if (dt < dpTempStart) { dpTempEnd = dpTempStart; dpTempStart = dt; }
    else dpTempEnd = dt;
  }
  if (dpTempStart) document.getElementById('dpStartDate').value = fmtDateInput(dpTempStart);
  if (dpTempEnd) document.getElementById('dpEndDate').value = fmtDateInput(dpTempEnd);
  renderCalendars();
}

function applyDatePicker() {
  if (dpMode === 'rolling') {
    let val = parseInt(document.getElementById('dpRollingVal').value) || 14;
    const unit = document.getElementById('dpRollingUnit').value;
    if (unit === 'months') val = val * 30;
    dpDays = val;
    dpStartDate = null; dpEndDate = null;
    document.getElementById('dpLabel').textContent = `Last ${val} days`;
  } else {
    // Fixed mode
    const s = document.getElementById('dpStartDate').value;
    const e = document.getElementById('dpEndDate').value;
    if (s && e) {
      dpStartDate = s; dpEndDate = e;
      dpDays = null;
      document.getElementById('dpLabel').textContent = fmtDateLabel(new Date(s)) + ' – ' + fmtDateLabel(new Date(e));
    }
  }
  closeDatePicker();
  refreshDashboard();
}

// ── Brand Switcher ──
async function loadWorkspaces() {
  const { data, error } = await sb.rpc('dashboard_workspaces');
  if (error) { console.error('workspaces error:', error); return; }
  allWorkspaces = data || [];
  const lastSlug = localStorage.getItem('dp_workspace');
  currentWorkspace = allWorkspaces.find(w => w.slug === lastSlug) || allWorkspaces[0];
  renderBrandSwitcher();
}

function renderBrandSwitcher() {
  if (!currentWorkspace) return;
  const initial = currentWorkspace.name.charAt(0).toUpperCase();
  const logoEl = document.getElementById('brandLogo');
  if (currentWorkspace.logo_url) {
    logoEl.outerHTML = `<img class="brand-logo" id="brandLogo" src="${currentWorkspace.logo_url}" alt="">`;
  } else {
    logoEl.outerHTML = `<span class="brand-logo-placeholder" id="brandLogo">${initial}</span>`;
  }
  document.getElementById('brandName').textContent = currentWorkspace.name;

  const dd = document.getElementById('brandDropdown');
  dd.innerHTML = allWorkspaces.map(w => {
    const active = w.workspace_id === currentWorkspace.workspace_id;
    const initial = w.name.charAt(0).toUpperCase();
    const logo = w.logo_url
      ? `<img class="brand-logo" src="${w.logo_url}" alt="">`
      : `<span class="brand-logo-placeholder">${initial}</span>`;
    return `<button class="brand-option${active ? ' active' : ''}" onclick="selectBrand('${w.slug}')">
      ${logo}
      <div><div class="bo-name">${w.name}</div><div class="bo-meta">${w.slug}</div></div>
      <span class="bo-check">&#10003;</span>
    </button>`;
  }).join('');
}

function toggleBrandPicker() {
  const dd = document.getElementById('brandDropdown');
  const btn = document.getElementById('brandBtn');
  if (dd.classList.contains('open')) { closeBrandPicker(); return; }
  const rect = btn.getBoundingClientRect();
  dd.style.top = (rect.bottom + 6) + 'px';
  dd.style.left = rect.left + 'px';
  dd.classList.add('open');
  btn.classList.add('open');
  setTimeout(() => document.addEventListener('click', closeBrandOutside), 10);
}

function closeBrandPicker() {
  document.getElementById('brandDropdown').classList.remove('open');
  document.getElementById('brandBtn').classList.remove('open');
  document.removeEventListener('click', closeBrandOutside);
}

function closeBrandOutside(e) {
  if (!document.getElementById('brandSwitcher').contains(e.target)) closeBrandPicker();
}

function selectBrand(slug) {
  const ws = allWorkspaces.find(w => w.slug === slug);
  if (!ws || ws.workspace_id === currentWorkspace.workspace_id) { closeBrandPicker(); return; }
  currentWorkspace = ws;
  localStorage.setItem('dp_workspace', ws.slug);
  closeBrandPicker();
  renderBrandSwitcher();
  refreshDashboard();
}

// ── Auth ──
async function checkSession() {
  const { data: { session } } = await sb.auth.getSession();
  if (session) {
    document.getElementById('loginOverlay').classList.add('hidden');
    await loadWorkspaces();
    await loadDashboard();
  }
}

async function handleLogin() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  const errEl = document.getElementById('loginError');
  const btn = document.getElementById('loginBtn');
  errEl.style.display = 'none';
  btn.disabled = true;
  btn.textContent = 'Signing in...';

  const { error } = await sb.auth.signInWithPassword({ email, password });
  if (error) {
    errEl.textContent = error.message;
    errEl.style.display = 'block';
    btn.disabled = false;
    btn.textContent = 'Sign In';
    return;
  }
  document.getElementById('loginOverlay').classList.add('hidden');
  await loadWorkspaces();
  await loadDashboard();
}

async function handleLogout() {
  await sb.auth.signOut();
  location.reload();
}

// Allow Enter key on login form
document.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !document.getElementById('loginOverlay').classList.contains('hidden')) {
    handleLogin();
  }
});

// ── Scoring (ported from Python) ──
function classifyCreative(row, ad7dMap) {
  const phase = (row.lifecycle_phase || 'unknown').toLowerCase();
  const ltRoas = Number(row.lifetime_roas) || 0;
  const ltSpend = Number(row.lifetime_spend) || 0;
  const ltCtr = Number(row.lifetime_ctr) || 0;
  const days = Number(row.days_active) || 1;
  const fatigue = row.current_fatigue_score != null ? Number(row.current_fatigue_score) : null;
  const d7 = ad7dMap[row.ad_id] || {};
  let roas7d = Number(d7.roas_7d) || 0;
  let spend7d = Number(d7.spend_7d) || 0;
  let ctr7d = Number(d7.ctr_7d) || 0;
  if (roas7d === 0 && ltRoas > 0) roas7d = ltRoas;
  const roasDelta = (ltRoas > 0 && roas7d > 0) ? ((roas7d - ltRoas) / ltRoas) * 100 : 0;
  const roasTrend = roasDelta > 10 ? 'up' : roasDelta < -10 ? 'down' : 'flat';
  let action;
  if (phase === 'declining' || (fatigue !== null && fatigue < 30)) action = 'KILL';
  else if (phase === 'scaling' && roas7d >= 2) action = 'SCALE';
  else if (phase === 'peak' && roas7d >= 1.5) action = 'MAINTAIN';
  else if (phase === 'peak' && roas7d < 1.5) action = 'WATCH';
  else if (phase === 'learning' && ltSpend < 5000) action = 'TEST';
  else action = 'MONITOR';
  const roasScore = Math.min(40, (roas7d / 3) * 40);
  const ctrUse = ctr7d > 0 ? ctr7d : ltCtr;
  const ctrScore = Math.min(20, (ctrUse / 1.5) * 20);
  const recencyScore = Math.max(0, 20 - Math.max(0, days - 60) * 0.5);
  const fatigueHealth = fatigue ?? 100;
  const fatigueScoreVal = (fatigueHealth / 100) * 20;
  const health = Math.min(100, Math.round(roasScore + ctrScore + recencyScore + fatigueScoreVal));
  return { action, health, roas_7d: +roas7d.toFixed(2), spend_7d: +spend7d.toFixed(2),
           ctr_7d: +ctrUse.toFixed(2), roas_trend: roasTrend, roas_delta: +roasDelta.toFixed(1) };
}

function computePortfolioHealth(creatives) {
  if (!creatives.length) return 0;
  const phases = {};
  creatives.forEach(c => { const p = (c.lifecycle_phase || 'unknown').toLowerCase(); phases[p] = (phases[p] || 0) + 1; });
  const total = creatives.length;
  const scaling = (phases['scaling'] || 0) / total;
  const peak = (phases['peak'] || 0) / total;
  const learning = (phases['learning'] || 0) / total;
  const declining = (phases['declining'] || 0) / total;
  const balance = Math.min(25, (scaling > 0.05 ? 8 : 0) + (peak > 0.3 ? 8 : 0) + (learning > 0.1 ? 5 : 0) + (declining < 0.1 ? 4 : 0));
  const avgRoas = creatives.reduce((s, c) => s + (c.roas_7d || 0), 0) / total;
  const roasPoints = Math.min(40, (avgRoas / 2) * 40);
  const products = new Set(creatives.map(c => (c.product || '').toLowerCase()));
  const diversity = Math.min(20, products.size * 7);
  const healthAvg = creatives.reduce((s, c) => s + (c.health || 0), 0) / total;
  const creativeHealth = Math.min(15, (healthAvg / 100) * 15);
  return Math.min(100, Math.round(balance + roasPoints + diversity + creativeHealth));
}

// ── Data Loading ──
async function loadDashboard() {
  document.getElementById('loadingOverlay').classList.remove('hidden');

  // Build daily params based on date picker (fetch 2x for comparison)
  const dailyParams = { p_account_id: currentWorkspace.meta_ad_account };
  if (dpStartDate && dpEndDate) {
    // For fixed range, compute duration and fetch 2x for prior comparison
    const startD = new Date(dpStartDate), endD = new Date(dpEndDate);
    const rangeDays = Math.ceil((endD - startD) / 86400000) + 1;
    const extStart = new Date(startD); extStart.setDate(extStart.getDate() - rangeDays);
    dailyParams.p_start_date = fmtDateInput(extStart);
    dailyParams.p_end_date = dpEndDate;
  } else {
    dailyParams.p_days = (dpDays || 30) * 2; // fetch 2x for prior period comparison
  }

  const breakdownParams = { p_account_id: currentWorkspace.meta_ad_account };
  if (dpStartDate && dpEndDate) {
    breakdownParams.p_start_date = dpStartDate;
    breakdownParams.p_end_date = dpEndDate;
  } else {
    breakdownParams.p_days = dpDays || 30;
  }

  const wsId = currentWorkspace.workspace_id;
  const acctId = currentWorkspace.meta_ad_account;

  const [dailyRes, creativesRes, ad7dRes, breakdownRes, campaignRes, adsetRes, productFunnelRes] = await Promise.all([
    sb.rpc('dashboard_daily', dailyParams),
    sb.rpc('dashboard_creatives', { p_workspace_id: wsId }),
    sb.rpc('dashboard_ad_7d', { p_account_id: acctId, p_limit: 200 }),
    sb.rpc('dashboard_breakdown', breakdownParams),
    sb.rpc('dashboard_campaign_breakdown', { p_workspace_id: wsId, p_account_id: acctId }),
    sb.rpc('dashboard_adset_breakdown', { p_workspace_id: wsId, p_account_id: acctId }),
    sb.rpc('dashboard_product_funnel', { p_workspace_id: wsId, p_days: dpDays || 30 })
  ]);

  if (dailyRes.error) { console.error('daily error:', dailyRes.error); }
  if (creativesRes.error) { console.error('creatives error:', creativesRes.error); }
  if (ad7dRes.error) { console.error('ad7d error:', ad7dRes.error); }
  if (breakdownRes.error) { console.error('breakdown error:', breakdownRes.error); }
  if (campaignRes.error) { console.error('campaign error:', campaignRes.error); }
  if (adsetRes.error) { console.error('adset error:', adsetRes.error); }
  if (productFunnelRes.error) { console.error('product funnel error:', productFunnelRes.error); }

  const ad7d = {};
  (ad7dRes.data || []).forEach(r => { ad7d[r.ad_id] = r; });

  const creatives = (creativesRes.data || []).map(c => ({
    ...c,
    ...classifyCreative(c, ad7d)
  }));

  DATA = {
    daily: dailyRes.data || [],
    creatives,
    breakdown: breakdownRes.data || [],
    campaigns: campaignRes.data || [],
    adsets: adsetRes.data || [],
    productFunnels: productFunnelRes.data || [],
    actionColors: { SCALE: '#3b82f6', MAINTAIN: '#22c55e', WATCH: '#eab308', KILL: '#ef4444', TEST: '#a855f7', MONITOR: '#6B7280' },
    phaseColors: { scaling: '#8A38F5', peak: '#22c55e', learning: '#3b82f6', declining: '#eab308', fatigued: '#ef4444', paused: '#6B7280' }
  };

  renderDashboard();
  document.getElementById('loadingOverlay').classList.add('hidden');
  document.getElementById('dashboardWrap').classList.add('visible');

  const now = new Date();
  document.getElementById('lastRefresh').textContent = 'Updated ' + now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });

  // Default sort for table (but stay at top of page)
  sortTable(3);
  // Ensure Overview tab is active on load
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  const overviewTab = document.querySelector('a[href="#overview"]');
  if (overviewTab) overviewTab.classList.add('active');
}

async function refreshDashboard() {
  // Destroy existing charts to avoid canvas reuse errors
  Chart.helpers.each(Chart.instances, (instance) => { instance.destroy(); });
  await loadDashboard();
}

// ── Helpers ──
function fmtCurrency(v) {
  v = Number(v) || 0;
  if (v >= 100000) return '\u20B9' + (v / 100000).toFixed(1) + 'L';
  if (v >= 1000) return '\u20B9' + (v / 1000).toFixed(1) + 'K';
  return '\u20B9' + Math.round(v);
}

function fmtNum(v) {
  v = Number(v) || 0;
  if (v >= 100000) return (v / 100000).toFixed(1) + 'L';
  if (v >= 1000) return (v / 1000).toFixed(1) + 'K';
  return v.toFixed(0);
}

// ── Render All Sections ──
function renderDashboard() {
  renderHero();
  renderKPIs();
  renderPhaseBar();
  renderSwimLanes();
  renderBreakdowns();
  renderTable();
  renderFunnel();
  renderAudienceSegments();
  renderAlerts();
  renderFooter();
  initSparklines();
  dailyChart();
  initAnimations();
  initNavTracking();
  // Ensure page starts at top after load
  setTimeout(() => window.scrollTo(0, 0), 100);
}

// ── Hero ──
function renderHero() {
  const count = DATA.creatives.length;
  const portfolioHealth = computePortfolioHealth(DATA.creatives);
  const periodLabel = document.getElementById('dpLabel').textContent;
  const brandName = currentWorkspace ? currentWorkspace.name : '';
  document.getElementById('heroSub').textContent = `${brandName} \u2022 ${count} active creatives \u2022 ${periodLabel}`;
  document.getElementById('portfolioScore').textContent = portfolioHealth + '/100';
}

// ── KPI Cards ──
function renderKPIs() {
  const d = DATA.daily;
  if (!d.length) return;
  // Split data in half: current period vs prior period
  const half = Math.ceil(d.length / 2);
  const curPeriod = d.slice(-half);
  const priorPeriod = d.slice(0, d.length - half);
  const periodDays = curPeriod.length;

  const sum = (arr, key) => arr.reduce((s, r) => s + (Number(r[key]) || 0), 0);
  const curSpend = sum(curPeriod, 'spend');
  const priorSpend = sum(priorPeriod, 'spend');
  const curPurchases = sum(curPeriod, 'purchases');
  const priorPurchases = sum(priorPeriod, 'purchases');
  const curRevenue = sum(curPeriod, 'revenue');
  const priorRevenue = sum(priorPeriod, 'revenue');
  const curRoas = curSpend > 0 ? curRevenue / curSpend : 0;
  const priorRoas = priorSpend > 0 ? priorRevenue / priorSpend : 0;
  const curCpp = curPurchases > 0 ? curSpend / curPurchases : 0;
  const priorCpp = priorPurchases > 0 ? priorSpend / priorPurchases : 0;
  const activeAds = DATA.creatives.length;

  const delta = (cur, prior) => {
    if (prior === 0) return { pct: 0, cls: 'up' };
    const pct = ((cur - prior) / prior * 100);
    return { pct: Math.abs(pct).toFixed(0), cls: pct >= 0 ? 'up' : 'down', arrow: pct >= 0 ? '\u2191' : '\u2193' };
  };

  const kpis = [
    { label: `Spend (${periodDays}d)`, val: fmtCurrency(curSpend), delta: delta(curSpend, priorSpend), sparkId: 'spark-spend', invert: true },
    { label: 'ROAS', val: curRoas.toFixed(2) + 'x', delta: delta(curRoas, priorRoas), sparkId: 'spark-roas' },
    { label: 'Cost/Purchase', val: fmtCurrency(curCpp), delta: delta(curCpp, priorCpp), sparkId: 'spark-cpp', invert: true },
    { label: 'Purchases', val: curPurchases, delta: delta(curPurchases, priorPurchases), sparkId: 'spark-purchases' },
    { label: 'Active Ads', val: activeAds, delta: { pct: '', cls: 'up', arrow: '' }, sparkId: null }
  ];

  const grid = document.getElementById('kpiGrid');
  grid.innerHTML = kpis.map(k => {
    const dCls = k.invert ? (k.delta.cls === 'up' ? 'down' : 'up') : k.delta.cls;
    return `<div class="kpi-card">
      <div class="kpi-label">${k.label}</div>
      <div class="kpi-val">${k.val}</div>
      ${k.delta.pct ? `<div class="kpi-delta ${dCls}">${k.delta.arrow} ${k.delta.pct}% vs prior</div>` : '<div class="kpi-delta" style="color:var(--text-dim)">—</div>'}
      ${k.sparkId ? `<div class="spark-wrap"><canvas id="${k.sparkId}" class="kpi-spark"></canvas></div>` : ''}
    </div>`;
  }).join('');
}

// ── Phase Bar ──
function renderPhaseBar() {
  const phases = { scaling: 0, peak: 0, learning: 0, declining: 0 };
  DATA.creatives.forEach(c => {
    const p = (c.lifecycle_phase || '').toLowerCase();
    if (phases.hasOwnProperty(p)) phases[p]++;
  });
  const total = DATA.creatives.length || 1;
  const colors = { scaling: '#8A38F5', peak: '#22c55e', learning: '#3b82f6', declining: '#eab308' };

  document.getElementById('phaseBarWrap').innerHTML = `
    <div class="phase-bar-title">CREATIVE HEALTH DISTRIBUTION</div>
    <div class="phase-bar">
      ${Object.entries(phases).map(([p, n]) => n > 0 ? `<div class="phase-seg" style="flex:${n};background:${colors[p]}">${n}</div>` : '').join('')}
    </div>
    <div class="phase-legend">
      ${Object.entries(phases).map(([p, n]) => `<span><div class="legend-dot" style="background:${colors[p]}"></div>${p.charAt(0).toUpperCase() + p.slice(1)} (${n})</span>`).join('')}
    </div>
  `;
}

// ── Swim Lanes ──
function renderSwimLanes() {
  const container = document.getElementById('swimLanesContainer');
  const laneOrder = ['scaling', 'peak', 'learning', 'declining'];
  const colors = DATA.phaseColors;

  const grouped = {};
  laneOrder.forEach(p => grouped[p] = []);
  DATA.creatives.forEach(c => {
    const p = (c.lifecycle_phase || '').toLowerCase();
    if (grouped[p]) grouped[p].push(c);
  });

  // Sort each lane
  grouped.scaling.sort((a, b) => (b.roas_7d || 0) - (a.roas_7d || 0));
  grouped.peak.sort((a, b) => (Number(b.lifetime_spend) || 0) - (Number(a.lifetime_spend) || 0));
  grouped.learning.sort((a, b) => (Number(b.lifetime_spend) || 0) - (Number(a.lifetime_spend) || 0));
  grouped.declining.sort((a, b) => (Number(b.lifetime_spend) || 0) - (Number(a.lifetime_spend) || 0));

  container.innerHTML = laneOrder.map(phase => {
    const ads = grouped[phase];
    if (!ads.length) return '';
    const color = colors[phase] || '#6B7280';
    const avgRoas = (ads.reduce((s, c) => s + (c.roas_7d || 0), 0) / ads.length).toFixed(2);
    const totalSpend7d = ads.reduce((s, c) => s + (c.spend_7d || 0), 0);

    const cards = ads.map(c => {
      const ac = DATA.actionColors[c.action] || '#6B7280';
      const pc = colors[phase];
      const prc = c.product === 'Varapace' ? '#8A38F5' : c.product === 'Varaspan' ? '#06b6d4' : c.product === 'VaraCare' ? '#22c55e' : '#6B7280';
      const trendIcon = c.roas_trend === 'up' ? '\u2191' : c.roas_trend === 'down' ? '\u2193' : '\u2192';
      const trendColor = c.roas_trend === 'up' ? '#22c55e' : c.roas_trend === 'down' ? '#ef4444' : '#6B7280';
      const thumbSrc = c.stored_thumbnail_url || c.hd_thumbnail_url || c.image_url || c.thumb;
      const thumbImg = thumbSrc ? `<img src="${thumbSrc}" style="width:100%;height:100%;object-fit:cover" loading="lazy" onerror="this.style.display='none'">` : '';
      const isVideo = !!c.video_id;
      const videoBadge = isVideo ? `<div class="video-badge"><svg width="8" height="10" viewBox="0 0 8 10" fill="white"><polygon points="0,0 8,5 0,10"/></svg>${c.video_duration ? ' ' + Number(c.video_duration).toFixed(0) + 's' : ''}</div>` : '';
      const healthColor = c.health >= 70 ? '#22c55e' : c.health >= 40 ? '#eab308' : '#ef4444';

      return `<div class="creative-card" onclick="openCreativeModal('${c.ad_id}')">
        <div class="card-thumb">${thumbImg}${videoBadge}</div>
        <div class="card-body">
          <div class="card-badges">
            <span class="badge" style="background:${prc}20;color:${prc}">${c.product || 'Other'}</span>
            <span class="badge" style="background:#F0F0F0;color:#6B7280">${c.format || 'Other'}</span>
          </div>
          <div class="card-name" title="${c.ad_name || ''}">${c.ad_name || 'Unknown'}</div>
          <div class="card-metrics">
            <div class="cm"><div class="cm-label">ROAS</div><div class="cm-val">${(Number(c.lifetime_roas) || 0).toFixed(2)}x</div></div>
            <div class="cm"><div class="cm-label">Spend</div><div class="cm-val">${fmtCurrency(c.lifetime_spend)}</div></div>
            <div class="cm"><div class="cm-label">7d ROAS</div><div class="cm-val" style="color:${trendColor}">${c.roas_7d.toFixed(2)}x ${trendIcon}</div></div>
            <div class="cm"><div class="cm-label">CPP</div><div class="cm-val">${fmtCurrency(c.lifetime_cpp)}</div></div>
          </div>
          <div class="card-footer">
            <div class="health-bar-mini"><div class="health-fill" style="width:${c.health}%;background:${healthColor}"></div></div>
            <span class="action-badge" style="background:${ac}20;color:${ac}">${c.action}</span>
          </div>
        </div>
      </div>`;
    }).join('');

    return `<div class="swim-lane fade-in">
      <div class="lane-header">
        <div class="lane-title">
          <div class="lane-dot" style="background:${color}"></div>
          <span class="lane-name">${phase.charAt(0).toUpperCase() + phase.slice(1)}</span>
          <span class="lane-count">${ads.length}</span>
        </div>
        <div class="lane-stats">
          <span>Avg ROAS: <b>${avgRoas}x</b></span>
          <span>7d Spend: <b>${fmtCurrency(totalSpend7d)}</b></span>
        </div>
      </div>
      <div class="lane-scroll">${cards}</div>
    </div>`;
  }).join('');
}

// ── Breakdowns ──
function switchBreakdown(tab) {
  document.querySelectorAll('.breakdown-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.breakdown-panel').forEach(p => p.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('bd-' + tab).classList.add('active');
}

function trendArrow(trend) {
  if (trend === 'up') return '<span class="trend-arrow up">&#9650;</span>';
  if (trend === 'down') return '<span class="trend-arrow down">&#9660;</span>';
  return '<span class="trend-arrow flat">&#8212;</span>';
}

function funnelBadge(stage) {
  const cls = (stage || 'other').toLowerCase().replace('+', '-').replace(' ', '');
  const map = { 'tof': 'tof', 'mof': 'mof', 'bof': 'bof', 'mof+bof': 'mof-bof', 'mofbof': 'mof-bof', 'awareness': 'other' };
  return `<span class="funnel-badge ${map[cls] || 'other'}">${stage}</span>`;
}

function shareBar(value, max) {
  const pct = max > 0 ? Math.min(100, (value / max) * 100) : 0;
  return `<div class="bd-share-bar"><div class="bd-share-fill" style="width:${pct}%"></div></div>`;
}

function renderBreakdowns() {
  renderCampaignBreakdown();
  renderAdsetBreakdown();
  renderProductBreakdown();
  renderFormatBreakdown();
}

function renderCampaignBreakdown() {
  const campaigns = DATA.campaigns || [];
  if (!campaigns.length) {
    document.getElementById('bd-campaign').innerHTML = '<p style="color:var(--text-muted);padding:20px">No campaign data available</p>';
    return;
  }
  const totalSpend = campaigns.reduce((s, c) => s + Number(c.lifetime_spend), 0);
  const maxSpend = Math.max(...campaigns.map(c => Number(c.lifetime_spend)));
  const currency = currentWorkspace.currency === 'INR' ? '\u20B9' : '$';

  // Group by funnel stage for summary row
  const rows = campaigns.map(c => {
    const spend = Number(c.lifetime_spend);
    const rev = Number(c.lifetime_revenue);
    const roas = Number(c.lifetime_roas);
    const s7d = Number(c.spend_7d);
    const r7d = Number(c.roas_7d);
    const pct = totalSpend > 0 ? ((spend / totalSpend) * 100).toFixed(1) : '0';
    const adsets = DATA.adsets.filter(a => a.campaign_id === c.campaign_id);
    const hasAdsets = adsets.length > 0;
    return `<tr class="${hasAdsets ? 'bd-expand-row' : ''}" ${hasAdsets ? `onclick="toggleAdsets('${c.campaign_id}')"` : ''}>
      <td class="td-name">${hasAdsets ? '<span class="bd-expand-icon" id="expand-' + c.campaign_id + '">&#9654;</span>' : '<span style="width:16px;display:inline-block"></span>'}${c.campaign_name}</td>
      <td>${funnelBadge(c.funnel_stage)}</td>
      <td><span class="funnel-badge other">${c.product_focus}</span></td>
      <td class="td-num">${c.ad_count} <span style="color:var(--text-dim);font-size:10px">(${c.active_ads} live)</span></td>
      <td class="td-num">${c.adset_count}</td>
      <td class="td-num">${fmtCurrency(spend)} ${shareBar(spend, maxSpend)}</td>
      <td class="td-num">${pct}%</td>
      <td class="td-num">${fmtCurrency(rev)}</td>
      <td class="td-num" style="color:${roas >= 2 ? 'var(--green)' : roas >= 1 ? 'var(--yellow)' : 'var(--red)'}">${roas.toFixed(2)}x</td>
      <td class="td-num">${fmtCurrency(s7d)}</td>
      <td class="td-num" style="color:${r7d >= 2 ? 'var(--green)' : r7d >= 1 ? 'var(--yellow)' : 'var(--red)'}">${r7d.toFixed(2)}x ${trendArrow(c.roas_trend)}</td>
    </tr>` + (hasAdsets ? adsets.map(a => {
      const as7d = Number(a.spend_7d);
      const ar7d = Number(a.roas_7d);
      return `<tr class="bd-child-row hidden" data-campaign="${c.campaign_id}">
        <td class="td-name" style="font-weight:400;font-size:12px">${a.adset_name}</td>
        <td></td>
        <td><span style="font-size:10px;color:var(--text-dim)">${a.formats || ''}</span></td>
        <td class="td-num">${a.ad_count} <span style="color:var(--text-dim);font-size:10px">(${a.active_ads} live)</span></td>
        <td class="td-num"></td>
        <td class="td-num">${fmtCurrency(Number(a.lifetime_spend))}</td>
        <td class="td-num">${totalSpend > 0 ? ((Number(a.lifetime_spend) / totalSpend) * 100).toFixed(1) : '0'}%</td>
        <td class="td-num">${fmtCurrency(Number(a.lifetime_revenue))}</td>
        <td class="td-num" style="color:${Number(a.lifetime_roas) >= 2 ? 'var(--green)' : Number(a.lifetime_roas) >= 1 ? 'var(--yellow)' : 'var(--red)'}">${Number(a.lifetime_roas).toFixed(2)}x</td>
        <td class="td-num">${fmtCurrency(as7d)}</td>
        <td class="td-num" style="color:${ar7d >= 2 ? 'var(--green)' : ar7d >= 1 ? 'var(--yellow)' : 'var(--red)'}">${ar7d.toFixed(2)}x ${trendArrow(a.roas_trend)}</td>
      </tr>`;
    }).join('') : '');
  }).join('');

  // Summary row
  const totalRev = campaigns.reduce((s, c) => s + Number(c.lifetime_revenue), 0);
  const totalRoas = totalSpend > 0 ? (totalRev / totalSpend) : 0;
  const total7d = campaigns.reduce((s, c) => s + Number(c.spend_7d), 0);
  const totalRev7d = campaigns.reduce((s, c) => s + Number(c.revenue_7d), 0);
  const totalRoas7d = total7d > 0 ? (totalRev7d / total7d) : 0;
  const totalAds = campaigns.reduce((s, c) => s + Number(c.ad_count), 0);

  document.getElementById('bd-campaign').innerHTML = `<div class="bd-table-wrap fade-in">
    <table class="bd-table">
      <thead><tr>
        <th>Campaign</th><th>Funnel</th><th>Product</th><th>Ads</th><th>Ad Sets</th>
        <th>Lifetime Spend</th><th>Share</th><th>Revenue</th><th>ROAS</th>
        <th>7d Spend</th><th>7d ROAS</th>
      </tr></thead>
      <tbody>
        ${rows}
        <tr class="bd-summary-row">
          <td>Total (${campaigns.length} campaigns)</td><td></td><td></td>
          <td class="td-num">${totalAds}</td><td></td>
          <td class="td-num">${fmtCurrency(totalSpend)}</td><td class="td-num">100%</td>
          <td class="td-num">${fmtCurrency(totalRev)}</td>
          <td class="td-num">${totalRoas.toFixed(2)}x</td>
          <td class="td-num">${fmtCurrency(total7d)}</td>
          <td class="td-num">${totalRoas7d.toFixed(2)}x</td>
        </tr>
      </tbody>
    </table>
  </div>`;
}

function toggleAdsets(campaignId) {
  const icon = document.getElementById('expand-' + campaignId);
  const rows = document.querySelectorAll(`tr[data-campaign="${campaignId}"]`);
  const isOpen = icon && icon.classList.contains('open');
  if (icon) icon.classList.toggle('open');
  rows.forEach(r => r.classList.toggle('hidden'));
}

function renderAdsetBreakdown() {
  const adsets = DATA.adsets || [];
  if (!adsets.length) {
    document.getElementById('bd-adset').innerHTML = '<p style="color:var(--text-muted);padding:20px">No ad set data available</p>';
    return;
  }
  const totalSpend = adsets.reduce((s, a) => s + Number(a.lifetime_spend), 0);
  const maxSpend = Math.max(...adsets.map(a => Number(a.lifetime_spend)));

  const rows = adsets.map(a => {
    const spend = Number(a.lifetime_spend);
    const roas = Number(a.lifetime_roas);
    const s7d = Number(a.spend_7d);
    const r7d = Number(a.roas_7d);
    const pct = totalSpend > 0 ? ((spend / totalSpend) * 100).toFixed(1) : '0';
    return `<tr>
      <td class="td-name">${a.adset_name}</td>
      <td style="font-size:12px;color:var(--text-muted)">${a.campaign_name || ''}</td>
      <td>${funnelBadge(a.funnel_stage)}</td>
      <td><span style="font-size:11px;color:var(--text-dim)">${a.formats || ''}</span></td>
      <td class="td-num">${a.ad_count} <span style="color:var(--text-dim);font-size:10px">(${a.active_ads} live)</span></td>
      <td class="td-num">${fmtCurrency(spend)} ${shareBar(spend, maxSpend)}</td>
      <td class="td-num">${pct}%</td>
      <td class="td-num">${fmtCurrency(Number(a.lifetime_revenue))}</td>
      <td class="td-num" style="color:${roas >= 2 ? 'var(--green)' : roas >= 1 ? 'var(--yellow)' : 'var(--red)'}">${roas.toFixed(2)}x</td>
      <td class="td-num">${fmtCurrency(s7d)} ${trendArrow(a.spend_trend)}</td>
      <td class="td-num" style="color:${r7d >= 2 ? 'var(--green)' : r7d >= 1 ? 'var(--yellow)' : 'var(--red)'}">${r7d.toFixed(2)}x ${trendArrow(a.roas_trend)}</td>
    </tr>`;
  }).join('');

  document.getElementById('bd-adset').innerHTML = `<div class="bd-table-wrap fade-in">
    <table class="bd-table">
      <thead><tr>
        <th>Ad Set</th><th>Campaign</th><th>Funnel</th><th>Formats</th><th>Ads</th>
        <th>Lifetime Spend</th><th>Share</th><th>Revenue</th><th>ROAS</th>
        <th>7d Spend</th><th>7d ROAS</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>
  </div>`;
}

function renderProductBreakdown() {
  const creatives = DATA.creatives || [];
  const groups = {};
  creatives.forEach(c => {
    const p = c.product || 'Other';
    if (!groups[p]) groups[p] = { ads: [], spend: 0, rev: 0, s7d: 0, r7d: 0, impressions: 0, clicks: 0, conversions: 0 };
    groups[p].ads.push(c);
    groups[p].spend += Number(c.lifetime_spend) || 0;
    groups[p].rev += Number(c.lifetime_value) || 0;
    groups[p].s7d += Number(c.spend_7d) || 0;
    groups[p].r7d += Number(c.current_7d_spend) || 0;
    groups[p].impressions += Number(c.lifetime_impressions) || 0;
    groups[p].clicks += Number(c.lifetime_clicks) || 0;
    groups[p].conversions += Number(c.lifetime_conversions) || 0;
  });
  const totalSpend = Object.values(groups).reduce((s, g) => s + g.spend, 0);
  const maxSpend = Math.max(...Object.values(groups).map(g => g.spend));
  const rows = Object.entries(groups).sort((a, b) => b[1].spend - a[1].spend).map(([name, g]) => {
    const roas = g.spend > 0 ? (g.rev / g.spend) : 0;
    const ctr = g.impressions > 0 ? (g.clicks / g.impressions * 100) : 0;
    const pct = totalSpend > 0 ? ((g.spend / totalSpend) * 100).toFixed(1) : '0';
    const active = g.ads.filter(a => ['scaling','testing','rising'].includes((a.lifecycle_phase||'').toLowerCase())).length;
    return `<tr>
      <td class="td-name" style="font-weight:600">${name}</td>
      <td class="td-num">${g.ads.length} <span style="color:var(--text-dim);font-size:10px">(${active} live)</span></td>
      <td class="td-num">${fmtCurrency(g.spend)} ${shareBar(g.spend, maxSpend)}</td>
      <td class="td-num">${pct}%</td>
      <td class="td-num">${fmtCurrency(g.rev)}</td>
      <td class="td-num" style="color:${roas >= 2 ? 'var(--green)' : roas >= 1 ? 'var(--yellow)' : 'var(--red)'}">${roas.toFixed(2)}x</td>
      <td class="td-num">${fmtNum(g.impressions)}</td>
      <td class="td-num">${fmtNum(g.clicks)}</td>
      <td class="td-num">${ctr.toFixed(2)}%</td>
      <td class="td-num">${Math.round(g.conversions)}</td>
    </tr>`;
  }).join('');
  document.getElementById('bd-product').innerHTML = `<div class="bd-table-wrap fade-in">
    <table class="bd-table">
      <thead><tr>
        <th>Product</th><th>Ads</th><th>Lifetime Spend</th><th>Share</th>
        <th>Revenue</th><th>ROAS</th><th>Impressions</th><th>Clicks</th><th>CTR</th><th>Conversions</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>
  </div>`;
}

function renderFormatBreakdown() {
  const creatives = DATA.creatives || [];
  const groups = {};
  creatives.forEach(c => {
    const f = (c.format || 'unknown').toLowerCase();
    const label = f.charAt(0).toUpperCase() + f.slice(1);
    if (!groups[label]) groups[label] = { ads: [], spend: 0, rev: 0, impressions: 0, clicks: 0, conversions: 0 };
    groups[label].ads.push(c);
    groups[label].spend += Number(c.lifetime_spend) || 0;
    groups[label].rev += Number(c.lifetime_value) || 0;
    groups[label].impressions += Number(c.lifetime_impressions) || 0;
    groups[label].clicks += Number(c.lifetime_clicks) || 0;
    groups[label].conversions += Number(c.lifetime_conversions) || 0;
  });
  const totalSpend = Object.values(groups).reduce((s, g) => s + g.spend, 0);
  const maxSpend = Math.max(...Object.values(groups).map(g => g.spend));
  const fmtIcons = { 'Video': '\uD83C\uDFA5', 'Image': '\uD83D\uDDBC\uFE0F', 'Carousel': '\uD83D\uDDC3\uFE0F', 'Story': '\uD83D\uDCF1' };
  const rows = Object.entries(groups).sort((a, b) => b[1].spend - a[1].spend).map(([name, g]) => {
    const roas = g.spend > 0 ? (g.rev / g.spend) : 0;
    const ctr = g.impressions > 0 ? (g.clicks / g.impressions * 100) : 0;
    const pct = totalSpend > 0 ? ((g.spend / totalSpend) * 100).toFixed(1) : '0';
    return `<tr>
      <td class="td-name" style="font-weight:600">${fmtIcons[name] || '\uD83D\uDCC4'} ${name}</td>
      <td class="td-num">${g.ads.length}</td>
      <td class="td-num">${fmtCurrency(g.spend)} ${shareBar(g.spend, maxSpend)}</td>
      <td class="td-num">${pct}%</td>
      <td class="td-num">${fmtCurrency(g.rev)}</td>
      <td class="td-num" style="color:${roas >= 2 ? 'var(--green)' : roas >= 1 ? 'var(--yellow)' : 'var(--red)'}">${roas.toFixed(2)}x</td>
      <td class="td-num">${fmtNum(g.impressions)}</td>
      <td class="td-num">${fmtNum(g.clicks)}</td>
      <td class="td-num">${ctr.toFixed(2)}%</td>
      <td class="td-num">${Math.round(g.conversions)}</td>
    </tr>`;
  }).join('');
  document.getElementById('bd-format').innerHTML = `<div class="bd-table-wrap fade-in">
    <table class="bd-table">
      <thead><tr>
        <th>Format</th><th>Ads</th><th>Lifetime Spend</th><th>Share</th>
        <th>Revenue</th><th>ROAS</th><th>Impressions</th><th>Clicks</th><th>CTR</th><th>Conversions</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>
  </div>`;
}

// ── Table ──
function renderTable() {
  const tbody = document.getElementById('tableBody');
  const fmtIcon = (f) => {
    f = (f || '').toLowerCase();
    if (f === 'video') return '\uD83C\uDFA5';
    if (f === 'carousel') return '\uD83D\uDDBC\uFE0F';
    return '\uD83D\uDCF7';
  };

  tbody.innerHTML = DATA.creatives.map(c => {
    const phase = (c.lifecycle_phase || 'unknown').toLowerCase();
    const product = (c.product || 'Other').toLowerCase();
    const fmt = (c.format || 'Other').toLowerCase();
    const action = (c.action || 'MONITOR').toLowerCase();
    const name = (c.ad_name || '').toLowerCase();
    const ac = DATA.actionColors[c.action] || '#6B7280';
    const pc = DATA.phaseColors[phase] || '#6B7280';
    const prc = product === 'varapace' ? '#8A38F5' : product === 'varaspan' ? '#06b6d4' : product === 'varacare' ? '#22c55e' : '#6B7280';
    const trendIcon = c.roas_trend === 'up' ? '\u2191' : c.roas_trend === 'down' ? '\u2193' : '\u2192';
    const trendColor = c.roas_trend === 'up' ? '#22c55e' : c.roas_trend === 'down' ? '#ef4444' : '#9CA3AF';
    const healthColor = c.health >= 70 ? '#22c55e' : c.health >= 40 ? '#eab308' : '#ef4444';
    const ltSpend = Number(c.lifetime_spend) || 0;
    const ltRoas = Number(c.lifetime_roas) || 0;
    const ltCpp = Number(c.lifetime_cpp) || 0;
    const ltCtr = Number(c.lifetime_ctr) || 0;
    const days = Number(c.days_active) || 0;

    const thumbSrc = c.stored_thumbnail_url || c.hd_thumbnail_url || c.image_url || c.thumb;
    const thumbCell = thumbSrc
      ? `<img src="${thumbSrc}" class="table-thumb" loading="lazy" onerror="this.style.display='none'">`
      : '<div class="thumb-placeholder">\uD83D\uDCC4</div>';

    return `<tr data-phase="${phase}" data-product="${product}" data-format="${fmt}" data-action="${action}" data-name="${name}" data-ad-id="${c.ad_id}" onclick="openCreativeModal('${c.ad_id}')" style="cursor:pointer">
      <td class="td-creative"><div class="creative-cell">${thumbCell}<div class="creative-info"><span class="table-name">${c.ad_name || 'Unknown'}</span><span class="table-sub">${fmtIcon(c.format)} ${c.format || 'Other'}</span></div></div></td>
      <td><span class="badge-sm" style="background:${prc}20;color:${prc}">${c.product || 'Other'}</span></td>
      <td><span class="badge-sm" style="background:${pc}20;color:${pc}">${c.lifecycle_phase || 'Unknown'}</span></td>
      <td data-sort="${ltSpend}" class="td-num">${fmtCurrency(ltSpend)}</td>
      <td data-sort="${c.spend_7d}" class="td-num">${c.spend_7d > 0 ? fmtCurrency(c.spend_7d) : '\u2014'}</td>
      <td data-sort="${ltRoas}" class="td-num">${ltRoas.toFixed(2)}x</td>
      <td data-sort="${c.roas_7d}" class="td-num" style="color:${trendColor}">${c.roas_7d.toFixed(2)}x ${trendIcon}</td>
      <td data-sort="${ltCpp}" class="td-num">${fmtCurrency(ltCpp)}</td>
      <td data-sort="${ltCtr}" class="td-num">${(ltCtr * 100).toFixed(2)}%</td>
      <td data-sort="${days}" class="td-num">${days}d</td>
      <td data-sort="${c.health}" class="td-num"><div class="health-bar-table"><div style="width:${c.health}%;height:100%;background:${healthColor};border-radius:4px"></div></div><span class="health-num">${c.health}</span></td>
      <td><span class="action-badge-sm" style="background:${ac}20;color:${ac}">${c.action}</span></td>
    </tr>`;
  }).join('');

  document.getElementById('row-count').textContent = DATA.creatives.length + ' creatives';
}

// ── Funnel ──
function renderFunnel() {
  const d = DATA.daily;
  const sum = (key) => d.reduce((s, r) => s + (Number(r[key]) || 0), 0);

  const steps = [
    { label: 'Impressions', key: 'impressions' },
    { label: 'Link Clicks', key: 'link_clicks' },
    { label: 'Landing Page Views', key: 'lpv' },
    { label: 'Add to Cart', key: 'atc' },
    { label: 'Checkout Initiated', key: 'ic' },
    { label: 'Purchases', key: 'purchases' }
  ];

  const vals = steps.map(s => ({ ...s, val: sum(s.key) }));
  const maxVal = vals[0].val || 1;

  // Funnel steps HTML
  const stepsHtml = vals.map((s, i) => {
    const pct = ((s.val / maxVal) * 100).toFixed(0);
    const convRate = i > 0 && vals[i - 1].val > 0 ? ((s.val / vals[i - 1].val) * 100).toFixed(1) : '';
    return `<div class="funnel-step">
      <div class="funnel-info">
        <span class="funnel-label">${s.label}</span>
        <span class="funnel-val">${fmtNum(s.val)}</span>
        ${convRate ? `<span class="funnel-conv">${convRate}%</span>` : ''}
      </div>
      <div class="funnel-bar-wrap"><div class="funnel-bar" style="width:${pct}%"></div></div>
    </div>`;
  }).join('');

  // Leak rates
  const leaks = [];
  for (let i = 1; i < vals.length; i++) {
    const drop = vals[i - 1].val > 0 ? ((1 - vals[i].val / vals[i - 1].val) * 100).toFixed(1) : 0;
    leaks.push({ from: vals[i - 1].label, to: vals[i].label, drop });
  }
  const worstLeak = leaks.reduce((w, l) => Number(l.drop) > Number(w.drop) ? l : w, leaks[0]);

  const leakHtml = leaks.map(l => `
    <div class="leak-item">
      <span>${l.from} \u2192 ${l.to}</span>
      <span class="leak-rate" style="color:${Number(l.drop) > 50 ? '#ef4444' : Number(l.drop) > 20 ? '#eab308' : '#22c55e'}">${l.drop}% drop</span>
    </div>
  `).join('');

  document.getElementById('funnelWrap').innerHTML = `
    <div class="funnel-steps">${stepsHtml}</div>
    <div class="funnel-health">
      <h3>Funnel Health</h3>
      ${leakHtml}
      ${worstLeak ? `<div class="worst-leak"><strong>Biggest leak:</strong> ${worstLeak.from} \u2192 ${worstLeak.to} (${worstLeak.drop}% drop)</div>` : ''}
    </div>
  `;

  // Product funnel tabs
  renderProductFunnels();
}

function switchFunnelTab(btn, product) {
  document.querySelectorAll('#funnelTabs .breakdown-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  if (product === 'all') {
    document.getElementById('funnelWrap').style.display = '';
    document.getElementById('productFunnelWrap').style.display = 'none';
  } else {
    document.getElementById('funnelWrap').style.display = 'none';
    document.getElementById('productFunnelWrap').style.display = '';
    renderSingleProductFunnel(product);
  }
}

function renderProductFunnels() {
  const products = (DATA.productFunnels || []).filter(p => Number(p.total_spend) > 100);
  if (!products.length) return;

  // Add product tabs
  const tabsEl = document.getElementById('funnelTabs');
  products.forEach(p => {
    const btn = document.createElement('button');
    btn.className = 'breakdown-tab';
    btn.textContent = p.product;
    btn.onclick = function() { switchFunnelTab(this, p.product); };
    tabsEl.appendChild(btn);
  });

  // Also render side-by-side comparison
  document.getElementById('productFunnelWrap').style.display = 'none';
}

function renderSingleProductFunnel(productName) {
  const p = (DATA.productFunnels || []).find(f => f.product === productName);
  if (!p) return;

  const steps = [
    { label: 'Impressions', val: Number(p.total_impressions) },
    { label: 'Clicks', val: Number(p.total_clicks) },
    { label: 'Link Clicks', val: Number(p.link_clicks) },
    { label: 'Landing Page Views', val: Number(p.landing_page_views) },
    { label: 'Content Views', val: Number(p.content_views) },
    { label: 'Add to Cart', val: Number(p.adds_to_cart) },
    { label: 'Checkout', val: Number(p.checkouts_initiated) },
    { label: 'Purchases', val: Number(p.purchases) }
  ];
  const maxVal = steps[0].val || 1;

  const stepsHtml = steps.map((s, i) => {
    const pct = ((s.val / maxVal) * 100).toFixed(0);
    const convRate = i > 0 && steps[i - 1].val > 0 ? ((s.val / steps[i - 1].val) * 100).toFixed(1) : '';
    return `<div class="funnel-step">
      <div class="funnel-info">
        <span class="funnel-label">${s.label}</span>
        <span class="funnel-val">${fmtNum(s.val)}</span>
        ${convRate ? `<span class="funnel-conv">${convRate}%</span>` : ''}
      </div>
      <div class="funnel-bar-wrap"><div class="funnel-bar" style="width:${pct}%"></div></div>
    </div>`;
  }).join('');

  // Key metrics
  const spend = Number(p.total_spend);
  const rev = Number(p.purchase_value);
  const roas = Number(p.roas);
  const cpc = Number(p.cpc);
  const cpp = Number(p.cpp);
  const adCount = Number(p.ad_count);

  // Leak rates
  const leaks = [];
  for (let i = 1; i < steps.length; i++) {
    if (steps[i - 1].val > 0) {
      const drop = ((1 - steps[i].val / steps[i - 1].val) * 100).toFixed(1);
      leaks.push({ from: steps[i - 1].label, to: steps[i].label, drop });
    }
  }
  const worstLeak = leaks.length ? leaks.reduce((w, l) => Number(l.drop) > Number(w.drop) ? l : w, leaks[0]) : null;

  const leakHtml = leaks.map(l => `
    <div class="leak-item">
      <span>${l.from} \u2192 ${l.to}</span>
      <span class="leak-rate" style="color:${Number(l.drop) > 50 ? '#ef4444' : Number(l.drop) > 20 ? '#eab308' : '#22c55e'}">${l.drop}% drop</span>
    </div>
  `).join('');

  document.getElementById('productFunnelWrap').innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px">
      <div class="funnel-steps">${stepsHtml}</div>
      <div>
        <div class="funnel-health" style="margin-bottom:16px">
          <h3>${productName} Summary</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:16px 0">
            <div><span class="boco-label" style="font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-dim)">Spend</span><br><span style="font-family:var(--font-mono);font-size:18px;font-weight:600">${fmtCurrency(spend)}</span></div>
            <div><span class="boco-label" style="font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-dim)">Revenue</span><br><span style="font-family:var(--font-mono);font-size:18px;font-weight:600">${fmtCurrency(rev)}</span></div>
            <div><span class="boco-label" style="font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-dim)">ROAS</span><br><span style="font-family:var(--font-mono);font-size:18px;font-weight:600;color:${roas >= 2 ? 'var(--green)' : roas >= 1 ? 'var(--yellow)' : 'var(--red)'}">${roas.toFixed(2)}x</span></div>
            <div><span class="boco-label" style="font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-dim)">Cost/Purchase</span><br><span style="font-family:var(--font-mono);font-size:18px;font-weight:600">${fmtCurrency(cpp)}</span></div>
            <div><span class="boco-label" style="font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-dim)">CPC</span><br><span style="font-family:var(--font-mono);font-size:18px;font-weight:600">${fmtCurrency(cpc)}</span></div>
            <div><span class="boco-label" style="font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-dim)">Active Ads</span><br><span style="font-family:var(--font-mono);font-size:18px;font-weight:600">${adCount}</span></div>
          </div>
        </div>
        <div class="funnel-health">
          <h3>Funnel Leaks</h3>
          ${leakHtml}
          ${worstLeak ? `<div class="worst-leak" style="margin-top:12px"><strong>Biggest leak:</strong> ${worstLeak.from} \u2192 ${worstLeak.to} (${worstLeak.drop}% drop)</div>` : ''}
        </div>
      </div>
    </div>`;
}

// ── Audience Segments ──
function renderAudienceSegments(type) {
  type = type || 'age';
  const rows = (DATA.breakdown || []).filter(r => r.breakdown_type === type && r.spend > 0);
  const totalSpend = rows.reduce((s, r) => s + Number(r.spend), 0) || 1;
  const container = document.getElementById('audienceContainer');
  if (!rows.length) {
    container.innerHTML = '<p style="color:var(--text-muted)">No audience data for this period.</p>';
    return;
  }

  const nameMap = { mobile_app: 'Mobile App', mobile_web: 'Mobile Web', desktop: 'Desktop',
    instagram: 'Instagram', facebook: 'Facebook', messenger: 'Messenger', threads: 'Threads',
    audience_network: 'Audience Network', unknown: 'Unknown', IN: 'India', US: 'United States' };

  function roasColor(r) { return r >= 2 ? '#22c55e' : r >= 1.5 ? '#3b82f6' : r >= 1 ? '#eab308' : '#ef4444'; }
  function fmtM(v) { v = Number(v); if (v >= 100000) return (v/100000).toFixed(1) + 'L'; if (v >= 1000) return (v/1000).toFixed(1) + 'K'; return v.toFixed(0); }

  container.innerHTML = '<div class="audience-grid">' + rows.map(r => {
    const pct = ((Number(r.spend) / totalSpend) * 100).toFixed(1);
    const rc = roasColor(Number(r.roas));
    const name = nameMap[r.breakdown_value] || r.breakdown_value;
    const cpp = Number(r.purchases) > 0 ? (Number(r.spend) / Number(r.purchases)).toFixed(0) : '—';
    return `<div class="segment-card">
      <div class="segment-name">${name}</div>
      <div class="segment-share">${pct}% of spend</div>
      <div class="segment-bar-wrap"><div class="segment-bar" style="width:${pct}%;background:${rc}"></div></div>
      <div class="segment-metrics">
        <div><div class="segment-metric-label">Spend</div><div class="segment-metric-value">\u20B9${fmtM(r.spend)}</div></div>
        <div><div class="segment-metric-label">ROAS</div><div class="segment-metric-value" style="color:${rc}">${Number(r.roas).toFixed(2)}x</div></div>
        <div><div class="segment-metric-label">Purchases</div><div class="segment-metric-value">${Number(r.purchases).toLocaleString()}</div></div>
        <div><div class="segment-metric-label">Cost/Purchase</div><div class="segment-metric-value">${cpp === '—' ? '—' : '\u20B9' + fmtM(cpp)}</div></div>
      </div>
    </div>`;
  }).join('') + '</div>';
}

function switchAudienceTab(btn, type) {
  document.querySelectorAll('.audience-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  renderAudienceSegments(type);
}

// ── Alerts ──
function renderAlerts() {
  const creatives = DATA.creatives;
  const alerts = [];

  // Scale-ready
  const scaleReady = creatives.filter(c => c.action === 'SCALE');
  if (scaleReady.length > 0) {
    alerts.push({
      icon: '\uD83D\uDE80', title: `${scaleReady.length} Ads Ready to Scale`,
      desc: `These ads are in scaling phase with 7d ROAS >= 2x. Consider increasing budgets.`,
      action: 'Review scaling ads in Swim Lanes',
      color: '#3b82f6'
    });
  }

  // Underperforming peak
  const watchAds = creatives.filter(c => c.action === 'WATCH');
  if (watchAds.length > 0) {
    alerts.push({
      icon: '\u26A0\uFE0F', title: `${watchAds.length} Peak Ads Underperforming`,
      desc: `These peak-phase ads have 7d ROAS below 1.5x. They may need creative refresh or audience optimization.`,
      action: 'Filter table by WATCH action',
      color: '#eab308'
    });
  }

  // Learning
  const learningAds = creatives.filter(c => c.action === 'TEST');
  if (learningAds.length > 0) {
    alerts.push({
      icon: '\uD83E\uDDEA', title: `${learningAds.length} Ads in Learning Phase`,
      desc: `New ads still gathering data. Avoid making changes until they exit the learning phase.`,
      action: 'Monitor in Table view',
      color: '#a855f7'
    });
  }

  // Kill candidates
  const killAds = creatives.filter(c => c.action === 'KILL');
  if (killAds.length > 0) {
    alerts.push({
      icon: '\uD83D\uDED1', title: `${killAds.length} Ads to Turn Off`,
      desc: `These ads are declining or fatigued with poor ROAS. Consider pausing to reallocate budget.`,
      action: 'Filter table by KILL action',
      color: '#ef4444'
    });
  }

  document.getElementById('alertsGrid').innerHTML = alerts.map(a => `
    <div class="alert-card" style="border-left:4px solid ${a.color}">
      <div class="alert-header">
        <span class="alert-icon">${a.icon}</span>
        <span class="alert-title">${a.title}</span>
      </div>
      <div class="alert-desc">${a.desc}</div>
      <div class="alert-action">${a.action}</div>
    </div>
  `).join('');
}

// ── Footer ──
function renderFooter() {
  const now = new Date();
  const ts = now.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' }) + ', ' +
             now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
  const health = computePortfolioHealth(DATA.creatives);
  document.getElementById('dashboardFooter').textContent =
    `Live data \u2022 ${ts} \u2022 ${DATA.creatives.length} creatives analyzed \u2022 Portfolio Health: ${health}/100`;
}

// ── Sparkline renderer ──
function sparkline(canvasId, values, color) {
  const canvas = document.getElementById(canvasId);
  if (!canvas || !values.length) return;
  new Chart(canvas, {
    type: 'line',
    data: {
      labels: values.map((_, i) => i),
      datasets: [{ data: values, borderColor: color, borderWidth: 1.5, pointRadius: 0, fill: true, backgroundColor: color + '15', tension: 0.4 }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false }, tooltip: { enabled: false } },
      scales: { x: { display: false }, y: { display: false } }
    }
  });
}

// ── Daily chart ──
function dailyChart() {
  const d = DATA.daily;
  if (!d || !d.length) return;
  const canvas = document.getElementById('chart-daily');
  if (!canvas) return;
  new Chart(canvas, {
    type: 'bar',
    data: {
      labels: d.map(r => r.date ? String(r.date).slice(5) : ''),
      datasets: [
        {
          label: 'Spend', data: d.map(r => Number(r.spend) || 0),
          backgroundColor: 'rgba(138,56,245,0.6)', borderRadius: 4,
          yAxisID: 'y', order: 2
        },
        {
          label: 'ROAS', data: d.map(r => Math.min(Number(r.roas) || 0, 5)),
          type: 'line', borderColor: '#22c55e', borderWidth: 2,
          pointRadius: 2, pointBackgroundColor: '#22c55e',
          yAxisID: 'y1', order: 1, tension: 0.3
        },
        {
          label: 'Breakeven', data: d.map(() => 1),
          type: 'line', borderColor: '#ef444480', borderWidth: 1,
          borderDash: [6, 3], pointRadius: 0,
          yAxisID: 'y1', order: 0
        }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { labels: { color: '#6B7280', font: { size: 11 } } }
      },
      scales: {
        x: { ticks: { color: '#9CA3AF', font: { size: 10 } }, grid: { display: false } },
        y: { position: 'left', ticks: { color: '#9CA3AF', callback: v => v >= 1000 ? (v / 1000).toFixed(0) + 'K' : v }, grid: { color: '#E5E5E5' } },
        y1: { position: 'right', ticks: { color: '#22c55e', callback: v => v.toFixed(1) + 'x' }, grid: { display: false }, min: 0, max: 5, suggestedMax: 5 }
      }
    }
  });
}

// ── Sparklines from daily data ──
function initSparklines() {
  const d = DATA.daily;
  if (!d || !d.length) return;
  sparkline('spark-spend', d.map(r => Number(r.spend) || 0), '#8A38F5');
  sparkline('spark-roas', d.map(r => Number(r.roas) || 0), '#22c55e');
  sparkline('spark-cpp', d.map(r => Number(r.cpp) || 0), '#f97316');
  sparkline('spark-purchases', d.map(r => Number(r.purchases) || 0), '#3b82f6');
}

// ── Table sort ──
let sortCol = -1, sortDir = 1;
function sortTable(col) {
  const table = document.getElementById('creative-table');
  const tbody = table.querySelector('tbody');
  const rows = Array.from(tbody.querySelectorAll('tr'));
  const ths = table.querySelectorAll('th');

  if (sortCol === col) { sortDir *= -1; }
  else { sortCol = col; sortDir = -1; }

  ths.forEach(th => th.classList.remove('sorted'));
  if (ths[col]) ths[col].classList.add('sorted');

  rows.sort((a, b) => {
    let av, bv;
    if (col === 0) {
      av = a.cells[0].textContent.toLowerCase();
      bv = b.cells[0].textContent.toLowerCase();
      return sortDir * av.localeCompare(bv);
    }
    av = parseFloat(a.cells[col].getAttribute('data-sort') || a.cells[col].textContent.replace(/[\u20B9,%xKL ]/g, '')) || 0;
    bv = parseFloat(b.cells[col].getAttribute('data-sort') || b.cells[col].textContent.replace(/[\u20B9,%xKL ]/g, '')) || 0;
    return sortDir * (av - bv);
  });

  rows.forEach(r => tbody.appendChild(r));
}

// ── Table filter ──
function filterTable() {
  const search = document.getElementById('filter-search').value.toLowerCase();
  const phase = document.getElementById('filter-phase').value;
  const product = document.getElementById('filter-product').value;
  const format = document.getElementById('filter-format').value;
  const action = document.getElementById('filter-action').value;
  const rows = document.querySelectorAll('#creative-table tbody tr');
  let visible = 0;

  rows.forEach(row => {
    const rName = row.getAttribute('data-name') || '';
    const rPhase = row.getAttribute('data-phase') || '';
    const rProduct = row.getAttribute('data-product') || '';
    const rFormat = row.getAttribute('data-format') || '';
    const rAction = row.getAttribute('data-action') || '';

    const show = (
      (!search || rName.includes(search)) &&
      (!phase || rPhase === phase) &&
      (!product || rProduct === product) &&
      (!format || rFormat === format) &&
      (!action || rAction === action)
    );
    row.style.display = show ? '' : 'none';
    if (show) visible++;
  });

  document.getElementById('row-count').textContent = visible + ' creatives';
}

// ── Nav smooth scroll ──
function scrollTo_(e, id) {
  e.preventDefault();
  document.getElementById(id).scrollIntoView({ behavior: 'smooth' });
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  e.target.classList.add('active');
}

// ── Scroll animations ──
function initAnimations() {
  const els = document.querySelectorAll('.fade-in');
  const observer = new IntersectionObserver(entries => {
    entries.forEach(e => { if (e.isIntersecting) e.target.classList.add('visible'); });
  }, { threshold: 0.05 });
  els.forEach(el => observer.observe(el));
  setTimeout(() => els.forEach(el => el.classList.add('visible')), 500);
}

// ── Nav active tracking ──
function initNavTracking() {
  const sections = ['overview', 'swimlanes', 'table', 'funnel', 'alerts'];
  const observer = new IntersectionObserver(entries => {
    entries.forEach(e => {
      if (e.isIntersecting) {
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        const tab = document.querySelector(`.nav-tab[href="#${e.target.id}"]`);
        if (tab) tab.classList.add('active');
      }
    });
  }, { threshold: 0.2 });
  sections.forEach(id => {
    const el = document.getElementById(id);
    if (el) observer.observe(el);
  });
}

// ── Creative Detail Modal ──
function openCreativeModal(adId) {
  const c = DATA.creatives.find(x => x.ad_id === adId);
  if (!c) return;

  const overlay = document.getElementById('creativeModal');
  const modalBox = overlay.querySelector('.modal');
  const mediaEl = document.getElementById('modalMedia');
  const detailsEl = document.getElementById('modalDetails');

  const hasReels = !!(c.stored_vertical_thumb_url || c.vertical_thumbnail_url);
  const hdThumb = hasReels ? (c.stored_vertical_thumb_url || c.vertical_thumbnail_url) : (c.stored_thumbnail_url || c.hd_thumbnail_url || c.image_url || c.thumb);
  const isVideo = !!c.video_id;
  const videoSrc = c.video_source_url || '';
  const fbVideoUrl = c.video_id ? `https://www.facebook.com/ads/library/?id=${adId}` : '';
  const durationLabel = c.video_duration ? Number(c.video_duration).toFixed(0) + 's' : '';

  // Only use tall vertical modal for ads with a 9:16 reels version
  const isVertical = hasReels;
  modalBox.classList.toggle('modal-vertical', isVertical);

  if (isVideo && hdThumb) {
    // Show vertical thumbnail (prefer 9:16 reels thumb) with play overlay
    const playAction = videoSrc
      ? `onclick="playModalVideo(this, '${videoSrc.replace(/'/g, "\\'")}')"`
      : (c.video_id ? `onclick="playModalEmbed(this, '${c.video_id}')"` : '');
    mediaEl.innerHTML = `<div class="modal-video-wrap">
      <img id="modalThumb" src="${hdThumb}" alt="" style="width:100%;height:100%;object-fit:cover">
      <div class="video-play-overlay" id="videoPlayBtn" ${playAction}>
        <svg width="24" height="28" viewBox="0 0 24 28" fill="white"><polygon points="0,0 24,14 0,28"/></svg>
      </div>
      ${durationLabel ? `<div class="video-meta-badge">\uD83C\uDFA5 ${durationLabel}</div>` : ''}
    </div>`;
  } else if (isVideo && videoSrc) {
    // Fallback: direct video (no thumbnail)
    mediaEl.innerHTML = `<div class="modal-video-wrap">
      <video id="modalVideo" poster="" preload="metadata" playsinline>
        <source src="${videoSrc}" type="video/mp4">
      </video>
      <div class="video-play-overlay" id="videoPlayBtn" onclick="toggleModalVideo()">
        <svg width="24" height="28" viewBox="0 0 24 28" fill="white"><polygon points="0,0 24,14 0,28"/></svg>
      </div>
      ${durationLabel ? `<div class="video-meta-badge">\uD83C\uDFA5 ${durationLabel}</div>` : ''}
    </div>`;
  } else if (hdThumb) {
    mediaEl.innerHTML = `<img src="${hdThumb}" alt="" style="width:100%;height:100%;object-fit:cover" onerror="this.src='';this.alt='No image'">`;
  } else {
    mediaEl.innerHTML = '<div style="color:var(--text-muted);font-size:48px">\uD83D\uDCC4</div>';
  }

  const roas7d = c.roas_7d || 0;
  const spend7d = c.spend_7d || 0;
  const ltRoas = Number(c.lifetime_roas) || 0;
  const ltSpend = Number(c.lifetime_spend) || 0;
  const phase = c.lifecycle_phase || 'Unknown';
  const action = c.action || 'MONITOR';
  const health = c.health || 0;
  const product = c.product || 'Other';
  const fmt = c.format || 'Other';
  const daysActive = Number(c.days_active) || 0;
  const ctr = Number(c.lifetime_ctr) || 0;
  const cpm = Number(c.lifetime_cpm) || 0;
  const cpp = Number(c.lifetime_cpp) || 0;

  const ac = DATA.actionColors[action] || '#6B7280';
  const pc = DATA.phaseColors[(phase || '').toLowerCase()] || '#6B7280';

  const adLibraryUrl = c.ad_library_url || `https://www.facebook.com/ads/library/?id=${adId}`;

  detailsEl.innerHTML = `
    <div class="modal-title">${c.ad_name || 'Unknown'}</div>
    <div class="modal-badges">
      <span class="badge" style="background:${ac}20;color:${ac}">${action}</span>
      <span class="badge" style="background:${pc}20;color:${pc}">${phase}</span>
      <span class="badge" style="background:#F0F0F0;color:#6B7280">${fmt}</span>
      <span class="badge" style="background:#8A38F520;color:#8A38F5">${product}</span>
    </div>

    <div class="modal-section">
      <div class="modal-section-title">Performance</div>
      <div class="modal-metrics">
        <div class="modal-metric"><div class="label">7d ROAS</div><div class="value" style="color:${roas7d >= 2 ? '#22c55e' : roas7d >= 1 ? '#eab308' : '#ef4444'}">${roas7d.toFixed(2)}x</div></div>
        <div class="modal-metric"><div class="label">Lifetime ROAS</div><div class="value">${ltRoas.toFixed(2)}x</div></div>
        <div class="modal-metric"><div class="label">7d Spend</div><div class="value">${fmtCurrency(spend7d)}</div></div>
        <div class="modal-metric"><div class="label">Total Spend</div><div class="value">${fmtCurrency(ltSpend)}</div></div>
        <div class="modal-metric"><div class="label">CTR</div><div class="value">${(ctr * 100).toFixed(2)}%</div></div>
        <div class="modal-metric"><div class="label">CPM</div><div class="value">${fmtCurrency(cpm)}</div></div>
        <div class="modal-metric"><div class="label">Cost/Purchase</div><div class="value">${fmtCurrency(cpp)}</div></div>
        <div class="modal-metric"><div class="label">Days Active</div><div class="value">${daysActive}</div></div>
      </div>
    </div>

    <div class="modal-section">
      <div class="modal-section-title">Health Score</div>
      <div style="display:flex;align-items:center;gap:12px">
        <div style="flex:1;height:8px;background:var(--bg);border-radius:4px;overflow:hidden">
          <div style="width:${health}%;height:100%;background:${ac};border-radius:4px"></div>
        </div>
        <span style="font-weight:700;color:${ac}">${health}/100</span>
      </div>
    </div>

    ${c.primary_text ? `<div class="modal-section"><div class="modal-section-title">Ad Copy</div><div class="modal-adcopy">${String(c.primary_text).substring(0, 500)}</div></div>` : ''}

    <div class="modal-actions">
      <a href="${adLibraryUrl}" target="_blank" class="modal-btn primary">View on Facebook</a>
    </div>
  `;

  overlay.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function toggleModalVideo() {
  const vid = document.getElementById('modalVideo');
  const btn = document.getElementById('videoPlayBtn');
  if (!vid) return;
  if (vid.paused) {
    vid.play();
    btn.classList.add('hidden');
    vid.addEventListener('pause', () => btn.classList.remove('hidden'), { once: true });
    vid.addEventListener('ended', () => { btn.classList.remove('hidden'); vid.currentTime = 0; }, { once: true });
    vid.addEventListener('click', () => vid.pause());
  } else {
    vid.pause();
  }
}

function playModalVideo(btnEl, src) {
  // Swap thumbnail for inline video player
  const wrap = btnEl.closest('.modal-video-wrap');
  const thumb = wrap.querySelector('#modalThumb');
  if (!thumb) return;
  const video = document.createElement('video');
  video.id = 'modalVideo';
  video.style.cssText = 'width:100%;height:100%;object-fit:cover';
  video.setAttribute('playsinline', '');
  video.setAttribute('autoplay', '');
  video.innerHTML = `<source src="${src}" type="video/mp4">`;
  thumb.replaceWith(video);
  btnEl.classList.add('hidden');
  video.addEventListener('pause', () => btnEl.classList.remove('hidden'), { once: true });
  video.addEventListener('ended', () => { btnEl.classList.remove('hidden'); video.currentTime = 0; }, { once: true });
  video.addEventListener('click', () => video.pause());
}

function playModalEmbed(btnEl, videoId) {
  // Swap thumbnail for FB embed iframe (always uses original video_id — reels IDs aren't embeddable)
  const wrap = btnEl.closest('.modal-video-wrap');
  const thumb = wrap.querySelector('#modalThumb');
  if (!thumb) return;
  const embedUrl = `https://www.facebook.com/plugins/video.php?href=${encodeURIComponent(`https://www.facebook.com/watch/?v=${videoId}`)}&show_text=false&autoplay=true&width=480`;
  const iframe = document.createElement('iframe');
  iframe.src = embedUrl;
  iframe.style.cssText = 'width:100%;height:100%;border:none;overflow:hidden';
  iframe.setAttribute('scrolling', 'no');
  iframe.setAttribute('frameborder', '0');
  iframe.setAttribute('allowTransparency', 'true');
  iframe.setAttribute('allow', 'autoplay; clipboard-write; encrypted-media; picture-in-picture; web-share');
  iframe.setAttribute('allowFullScreen', 'true');
  thumb.replaceWith(iframe);
  btnEl.classList.add('hidden');
}

function closeCreativeModal() {
  document.getElementById('creativeModal').classList.remove('active');
  document.body.style.overflow = '';
  const vid = document.querySelector('#modalMedia video');
  if (vid) vid.pause();
  // Kill iframe embeds (FB video keeps playing otherwise)
  const iframe = document.querySelector('#modalMedia iframe');
  if (iframe) iframe.src = '';
}

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeCreativeModal();
});

// ── Init: check session on page load ──
// Dev bypass: skip auth during development
if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
  document.getElementById('loginOverlay').classList.add('hidden');
  const SB_STORAGE = 'https://dyktmiyvpnayqwwlqspe.supabase.co/storage/v1/object/public/brand-assets/logos';
  allWorkspaces = [
    { workspace_id: 'de8e2554-729a-422e-894d-ce399eca3a41', name: 'Varalife', slug: 'varalife', meta_ad_account: 'act_1215738472466123', logo_url: `${SB_STORAGE}/varalife.svg`, currency: 'INR' },
    { workspace_id: '67d68822-7a64-4ccd-b664-7e5dc5088c52', name: 'Stylish Wodrobe', slug: 'stylish-wodrobe', meta_ad_account: 'act_1473716013642041', logo_url: `${SB_STORAGE}/stylish-wodrobe.svg`, currency: 'INR' },
    { workspace_id: 'a7660de1-abe6-4b2c-a2b0-35f9c760e787', name: 'The Good Leaf', slug: 'the-good-leaf', meta_ad_account: 'act_710963902784708', logo_url: `${SB_STORAGE}/the-good-leaf.svg`, currency: 'INR' },
    { workspace_id: '684472b5-fbae-413e-97d6-fc7e1a2a2084', name: 'Uni Seoul', slug: 'uni-seoul', meta_ad_account: 'act_1386984256537337', logo_url: `${SB_STORAGE}/uni-seoul.svg`, currency: 'INR' }
  ];
  const lastSlug = localStorage.getItem('dp_workspace');
  currentWorkspace = allWorkspaces.find(w => w.slug === lastSlug) || allWorkspaces[0];
  renderBrandSwitcher();
  loadDashboard();
} else {
  checkSession();
}
</script>

</body>
</html>
