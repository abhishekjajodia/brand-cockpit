<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Varalife Creative Performance Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500&display=swap');

  :root {
    --bg: #0a0a0f;
    --bg-card: #12121a;
    --bg-card-hover: #1a1a25;
    --border: #1e1e2e;
    --text: #e4e4e7;
    --text-muted: #71717a;
    --text-dim: #52525b;
    --accent: #6366f1;
    --accent-light: #818cf8;
    --green: #22c55e;
    --green-dim: rgba(34,197,94,0.15);
    --red: #ef4444;
    --red-dim: rgba(239,68,68,0.15);
    --yellow: #eab308;
    --yellow-dim: rgba(234,179,8,0.15);
    --blue: #3b82f6;
    --blue-dim: rgba(59,130,246,0.15);
    --purple: #a855f7;
    --purple-dim: rgba(168,85,247,0.15);
    --orange: #f97316;
    --orange-dim: rgba(249,115,22,0.15);
    --cyan: #06b6d4;
  }

  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family: 'Inter', -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
  }
  .container { max-width: 1400px; margin: 0 auto; padding: 0 24px; }

  /* ── Login Screen ── */
  .login-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: var(--bg); z-index: 2000;
    display: flex; align-items: center; justify-content: center;
  }
  .login-overlay.hidden { display: none; }
  .login-box {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 16px; padding: 40px; width: 380px;
    text-align: center;
  }
  .login-box h2 {
    font-size: 24px; font-weight: 800;
    background: linear-gradient(135deg, #818cf8, #6366f1, #a855f7);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    margin-bottom: 4px;
  }
  .login-box .login-sub { font-size: 13px; color: var(--text-muted); margin-bottom: 28px; }
  .login-box input {
    width: 100%; padding: 12px 16px; border-radius: 8px;
    background: var(--bg); border: 1px solid var(--border);
    color: var(--text); font-size: 14px; font-family: inherit;
    margin-bottom: 12px; outline: none;
  }
  .login-box input:focus { border-color: var(--accent); }
  .login-box button {
    width: 100%; padding: 12px; border-radius: 8px;
    background: var(--accent); color: #fff; border: none;
    font-size: 14px; font-weight: 600; cursor: pointer;
    font-family: inherit; margin-top: 4px;
  }
  .login-box button:hover { background: var(--accent-light); }
  .login-box button:disabled { opacity: 0.5; cursor: not-allowed; }
  .login-error {
    color: var(--red); font-size: 13px; margin-top: 12px;
    display: none;
  }

  /* ── Loading Spinner ── */
  .loading-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: var(--bg); z-index: 1500;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center; gap: 16px;
  }
  .loading-overlay.hidden { display: none; }
  .spinner {
    width: 40px; height: 40px; border-radius: 50%;
    border: 3px solid var(--border); border-top-color: var(--accent);
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text { color: var(--text-muted); font-size: 14px; }

  /* ── Dashboard (hidden until loaded) ── */
  .dashboard-wrap { display: none; }
  .dashboard-wrap.visible { display: block; }

  /* ── Sticky Nav ── */
  .nav {
    position: sticky; top: 0; z-index: 100;
    background: rgba(10,10,15,0.85); backdrop-filter: blur(16px);
    border-bottom: 1px solid var(--border);
    padding: 0 24px;
  }
  .nav-inner {
    max-width: 1400px; margin: 0 auto;
    display: flex; align-items: center; gap: 8px;
    height: 52px; overflow-x: auto;
  }
  .nav-tab {
    padding: 8px 16px; border-radius: 8px;
    font-size: 13px; font-weight: 500; color: var(--text-muted);
    cursor: pointer; white-space: nowrap;
    transition: all 0.2s;
    text-decoration: none;
  }
  .nav-tab:hover, .nav-tab.active { color: var(--text); background: var(--bg-card); }
  .nav-brand {
    font-weight: 700; font-size: 14px; color: var(--accent-light);
    margin-right: 16px; white-space: nowrap;
  }
  .nav-right {
    margin-left: auto; display: flex; align-items: center; gap: 12px;
  }
  .refresh-btn {
    background: none; border: 1px solid var(--border); color: var(--text-muted);
    padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;
    font-family: inherit; display: flex; align-items: center; gap: 6px;
  }
  .refresh-btn:hover { border-color: var(--accent); color: var(--text); }
  .last-refresh { font-size: 11px; color: var(--text-dim); }
  .logout-btn {
    background: none; border: none; color: var(--text-dim);
    font-size: 12px; cursor: pointer; font-family: inherit;
  }
  .logout-btn:hover { color: var(--red); }

  /* ── Hero ── */
  .hero {
    padding: 60px 0 40px;
    text-align: center;
  }
  .hero h1 {
    font-size: 32px; font-weight: 800;
    background: linear-gradient(135deg, #818cf8, #6366f1, #a855f7);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .hero-sub { color: var(--text-muted); font-size: 14px; margin-top: 8px; }
  .portfolio-badge {
    display: inline-flex; align-items: center; gap: 8px;
    margin-top: 16px; padding: 8px 20px; border-radius: 20px;
    background: var(--bg-card); border: 1px solid var(--border);
    font-size: 14px; font-weight: 600;
  }
  .portfolio-score { font-family: 'JetBrains Mono'; font-size: 20px; color: var(--accent-light); }

  /* ── KPI Cards ── */
  .kpi-grid {
    display: grid; grid-template-columns: repeat(5, 1fr);
    gap: 16px; margin: 24px 0;
  }
  .kpi-card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 12px; padding: 20px;
    transition: all 0.2s;
  }
  .kpi-card:hover { border-color: var(--accent); transform: translateY(-2px); }
  .kpi-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); }
  .kpi-val { font-family: 'JetBrains Mono'; font-size: 24px; font-weight: 700; margin: 4px 0; }
  .kpi-delta { font-size: 12px; font-weight: 600; }
  .kpi-delta.up { color: var(--green); }
  .kpi-delta.down { color: var(--red); }
  .spark-wrap { position: relative; height: 36px; margin-top: 8px; }
  .kpi-spark { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

  /* ── Phase Summary Bar ── */
  .phase-bar-wrap {
    margin: 24px 0; background: var(--bg-card);
    border: 1px solid var(--border); border-radius: 12px;
    padding: 20px;
  }
  .phase-bar-title { font-size: 13px; font-weight: 600; margin-bottom: 12px; color: var(--text-muted); }
  .phase-bar {
    display: flex; height: 32px; border-radius: 8px; overflow: hidden;
  }
  .phase-seg { display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; color: #fff; min-width: 40px; }
  .phase-legend {
    display: flex; gap: 20px; margin-top: 12px; font-size: 12px; color: var(--text-muted);
  }
  .phase-legend span { display: flex; align-items: center; gap: 6px; }
  .legend-dot { width: 8px; height: 8px; border-radius: 50%; }

  /* ── Chart Section ── */
  .chart-wrap {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 12px; padding: 24px; margin: 24px 0;
    position: relative;
  }
  .chart-title { font-size: 15px; font-weight: 600; margin-bottom: 16px; }

  /* ── Section Headers ── */
  .section { padding: 48px 0 24px; }
  .section-header {
    display: flex; align-items: center; gap: 12px;
    margin-bottom: 24px;
  }
  .section-header h2 { font-size: 22px; font-weight: 700; }
  .section-header .section-line { flex: 1; height: 1px; background: var(--border); }

  /* ── Swim Lanes ── */
  .swim-lane { margin-bottom: 28px; }
  .lane-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 12px; padding: 0 4px;
  }
  .lane-title { display: flex; align-items: center; gap: 10px; }
  .lane-dot { width: 10px; height: 10px; border-radius: 50%; }
  .lane-name { font-size: 16px; font-weight: 700; }
  .lane-count { font-size: 12px; color: var(--text-muted); background: var(--bg-card); padding: 2px 10px; border-radius: 10px; }
  .lane-stats { display: flex; gap: 20px; font-size: 13px; color: var(--text-muted); }
  .lane-stats b { color: var(--text); }
  .lane-scroll {
    display: flex; gap: 16px; overflow-x: auto;
    scroll-snap-type: x mandatory; padding-bottom: 12px;
    -webkit-overflow-scrolling: touch;
  }
  .lane-scroll::-webkit-scrollbar { height: 4px; }
  .lane-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  /* ── Creative Cards ── */
  .creative-card {
    flex: 0 0 280px; scroll-snap-align: start;
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 12px; overflow: hidden;
    transition: all 0.2s; cursor: pointer; display: block;
  }
  .creative-card:hover { border-color: var(--accent); transform: translateY(-2px); }
  .card-thumb { width: 280px; height: 160px; background: #1e1e2e; overflow: hidden; }
  .card-thumb img { image-rendering: auto; }
  .card-body { padding: 14px; }
  .card-badges { display: flex; gap: 6px; margin-bottom: 8px; flex-wrap: wrap; }
  .badge {
    font-size: 10px; font-weight: 600; padding: 2px 8px;
    border-radius: 6px; text-transform: uppercase; letter-spacing: 0.5px;
  }
  .card-name {
    font-size: 12px; font-weight: 500; color: var(--text);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    margin-bottom: 10px;
  }
  .card-metrics { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 10px; }
  .cm { display: flex; flex-direction: column; }
  .cm-label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }
  .cm-val { font-family: 'JetBrains Mono'; font-size: 13px; font-weight: 600; }
  .card-footer { display: flex; align-items: center; gap: 8px; }
  .health-bar-mini { flex: 1; height: 4px; background: #1e1e2e; border-radius: 4px; overflow: hidden; }
  .health-fill { height: 100%; border-radius: 4px; transition: width 0.3s; }
  .action-badge {
    font-size: 10px; font-weight: 700; padding: 3px 8px;
    border-radius: 6px; letter-spacing: 0.5px;
  }

  /* ── Table ── */
  .filter-bar {
    display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;
  }
  .filter-bar input, .filter-bar select {
    background: var(--bg-card); border: 1px solid var(--border);
    color: var(--text); padding: 8px 14px; border-radius: 8px;
    font-size: 13px; font-family: inherit;
  }
  .filter-bar input { flex: 1; min-width: 200px; }
  .filter-bar select { min-width: 130px; }
  .filter-count { font-size: 12px; color: var(--text-muted); margin-left: auto; }

  .data-table-wrap {
    overflow-x: auto; border-radius: 12px;
    border: 1px solid var(--border);
    max-height: 75vh; overflow-y: auto;
  }
  .data-table {
    width: 100%; border-collapse: collapse;
    font-size: 13px;
  }
  .data-table th {
    background: var(--bg-card); padding: 12px 14px;
    text-align: left; font-size: 11px; text-transform: uppercase;
    letter-spacing: 0.5px; color: var(--text-muted); font-weight: 600;
    cursor: pointer; white-space: nowrap; position: sticky; top: 0;
    user-select: none;
  }
  .data-table th:hover { color: var(--text); }
  .data-table th .sort-icon { margin-left: 4px; opacity: 0.3; }
  .data-table th.sorted .sort-icon { opacity: 1; }
  .data-table td {
    padding: 10px 14px; border-top: 1px solid var(--border);
    white-space: nowrap; vertical-align: middle;
  }
  .data-table tr:hover td { background: var(--bg-card-hover); }
  .data-table tr { transition: background 0.15s; }
  .td-creative { min-width: 280px; white-space: normal; }
  .creative-cell { display: flex; align-items: center; gap: 10px; }
  .creative-cell img { flex-shrink: 0; }
  .creative-info { display: flex; flex-direction: column; gap: 2px; min-width: 0; }
  .data-table .table-name { font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 300px; display: block; }
  .table-sub { font-size: 11px; color: var(--text-muted); }
  .thumb-placeholder { width: 44px; height: 44px; border-radius: 6px; background: #1e1e2e; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
  .td-num { font-family: 'JetBrains Mono', monospace; font-size: 12px; }
  .badge-sm {
    font-size: 10px; font-weight: 600; padding: 2px 7px;
    border-radius: 4px;
  }
  .action-badge-sm {
    font-size: 10px; font-weight: 700; padding: 2px 7px;
    border-radius: 4px; letter-spacing: 0.5px;
  }
  .health-bar-table { display: inline-block; width: 50px; height: 4px; background: #1e1e2e; border-radius: 4px; vertical-align: middle; margin-right: 6px; overflow: hidden; }
  .health-num { font-family: 'JetBrains Mono'; font-size: 11px; color: var(--text-muted); }

  /* ── Funnel ── */
  .funnel-wrap {
    display: grid; grid-template-columns: 1fr 1fr; gap: 24px;
  }
  .funnel-steps { display: flex; flex-direction: column; gap: 8px; }
  .funnel-step { display: flex; align-items: center; gap: 16px; }
  .funnel-bar-wrap { flex: 1; height: 36px; background: #1e1e2e; border-radius: 6px; overflow: hidden; }
  .funnel-bar {
    height: 100%; border-radius: 6px;
    background: linear-gradient(90deg, var(--accent), var(--purple));
    transition: width 0.6s ease;
  }
  .funnel-info { min-width: 200px; display: flex; align-items: center; gap: 10px; }
  .funnel-label { font-size: 12px; color: var(--text-muted); min-width: 130px; }
  .funnel-val { font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600; }
  .funnel-conv {
    font-size: 11px; font-weight: 600; color: var(--accent-light);
    background: var(--accent)15; padding: 2px 6px; border-radius: 4px;
  }
  .funnel-health {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 12px; padding: 24px;
  }
  .funnel-health h3 { font-size: 15px; font-weight: 600; margin-bottom: 16px; }
  .leak-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: 8px 0; border-bottom: 1px solid var(--border);
    font-size: 13px;
  }
  .leak-rate { font-family: 'JetBrains Mono'; font-weight: 600; }
  .worst-leak {
    margin-top: 16px; padding: 12px 16px; border-radius: 8px;
    background: var(--red-dim); border: 1px solid var(--red)40;
    font-size: 13px;
  }

  /* ── Alerts ── */
  .alerts-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 16px; }
  .alert-card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 12px; padding: 20px;
    transition: all 0.2s;
  }
  .alert-card:hover { transform: translateY(-2px); }
  .alert-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
  .alert-icon { font-size: 20px; }
  .alert-title { font-size: 15px; font-weight: 700; }
  .alert-desc { font-size: 13px; color: var(--text-muted); margin-bottom: 12px; line-height: 1.5; }
  .alert-action {
    font-size: 12px; font-weight: 600; color: var(--accent-light);
    padding: 8px 12px; background: var(--accent)10; border-radius: 8px;
  }

  /* ── Footer ── */
  .footer {
    text-align: center; padding: 40px 0; margin-top: 40px;
    border-top: 1px solid var(--border);
    font-size: 12px; color: var(--text-dim);
  }

  /* ── Responsive ── */
  @media (max-width: 768px) {
    .kpi-grid { grid-template-columns: repeat(2, 1fr); }
    .funnel-wrap { grid-template-columns: 1fr; }
    .creative-card { flex: 0 0 260px; }
    .card-thumb { width: 260px; height: 140px; }
  }

  /* ── Animations ── */
  .fade-in {
    opacity: 0; transform: translateY(20px);
    transition: opacity 0.5s, transform 0.5s;
  }
  .fade-in.visible { opacity: 1; transform: translateY(0); }

  /* ── Creative Detail Modal ── */
  .modal-overlay {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85); z-index: 1000; align-items: center; justify-content: center;
    backdrop-filter: blur(4px);
  }
  .modal-overlay.active { display: flex; }
  .modal {
    background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px;
    max-width: 960px; width: 95%; max-height: 90vh; overflow-y: auto;
    display: grid; grid-template-columns: 1fr 1fr; gap: 0;
  }
  .modal-media {
    background: #000; border-radius: 16px 0 0 16px; display: flex;
    align-items: center; justify-content: center; min-height: 400px;
    position: relative; overflow: hidden;
  }
  .modal-media img { max-width: 100%; max-height: 80vh; object-fit: contain; }
  .modal-media video { max-width: 100%; max-height: 80vh; object-fit: contain; border-radius: 8px; }
  .modal-details { padding: 28px; overflow-y: auto; max-height: 90vh; }
  .modal-close {
    position: absolute; top: 12px; right: 12px; width: 36px; height: 36px;
    background: rgba(0,0,0,0.6); border: none; color: #fff; border-radius: 50%;
    font-size: 18px; cursor: pointer; z-index: 1001; display: flex;
    align-items: center; justify-content: center;
  }
  .modal-close:hover { background: rgba(255,255,255,0.2); }
  .modal-title { font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 16px; line-height: 1.4; }
  .modal-badges { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
  .modal-section { margin-bottom: 20px; }
  .modal-section-title { font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
  .modal-metrics { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .modal-metric { background: var(--bg); border-radius: 8px; padding: 12px; }
  .modal-metric .label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; }
  .modal-metric .value { font-size: 18px; font-weight: 700; color: var(--text); margin-top: 2px; }
  .modal-metric .sub { font-size: 11px; color: var(--text-muted); }
  .modal-adcopy { font-size: 13px; color: var(--text); line-height: 1.6; white-space: pre-wrap; max-height: 200px; overflow-y: auto; background: var(--bg); border-radius: 8px; padding: 12px; }
  .modal-actions { display: flex; gap: 8px; margin-top: 16px; }
  .modal-btn {
    padding: 8px 16px; border-radius: 8px; font-size: 12px; font-weight: 600;
    cursor: pointer; border: 1px solid var(--border); background: var(--bg);
    color: var(--text); text-decoration: none; display: inline-flex; align-items: center; gap: 6px;
  }
  .modal-btn:hover { border-color: var(--accent); color: var(--accent); }
  .modal-btn.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
  @media (max-width: 768px) {
    .modal { grid-template-columns: 1fr; }
    .modal-media { border-radius: 16px 16px 0 0; min-height: 250px; }
  }
</style>
</head>
<body>

<!-- Login Screen -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-box">
    <h2>Varalife Creative Hub</h2>
    <p class="login-sub">Sign in to access your creative dashboard</p>
    <input type="email" id="loginEmail" placeholder="Email" autocomplete="email">
    <input type="password" id="loginPassword" placeholder="Password" autocomplete="current-password">
    <button id="loginBtn" onclick="handleLogin()">Sign In</button>
    <div class="login-error" id="loginError"></div>
  </div>
</div>

<!-- Loading Spinner -->
<div class="loading-overlay hidden" id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text">Loading creative data...</div>
</div>

<!-- Dashboard (hidden until authenticated + data loaded) -->
<div class="dashboard-wrap" id="dashboardWrap">

<!-- Nav -->
<nav class="nav">
  <div class="nav-inner">
    <span class="nav-brand">Varalife Creative Hub</span>
    <a href="#overview" class="nav-tab" onclick="scrollTo_(event,'overview')">Overview</a>
    <a href="#swimlanes" class="nav-tab" onclick="scrollTo_(event,'swimlanes')">Swim Lanes</a>
    <a href="#table" class="nav-tab active" onclick="scrollTo_(event,'table')">Table</a>
    <a href="#funnel" class="nav-tab" onclick="scrollTo_(event,'funnel')">Funnel</a>
    <a href="#alerts" class="nav-tab" onclick="scrollTo_(event,'alerts')">Alerts</a>
    <div class="nav-right">
      <span class="last-refresh" id="lastRefresh"></span>
      <button class="refresh-btn" onclick="refreshDashboard()">&#8635; Refresh</button>
      <button class="logout-btn" onclick="handleLogout()">Sign out</button>
    </div>
  </div>
</nav>

<!-- Hero + KPIs -->
<section id="overview" class="section">
<div class="container">
  <div class="hero">
    <h1>Creative Performance Dashboard</h1>
    <p class="hero-sub" id="heroSub">Loading...</p>
    <div class="portfolio-badge">
      Portfolio Health <span class="portfolio-score" id="portfolioScore">--</span>
    </div>
  </div>

  <div class="kpi-grid" id="kpiGrid"></div>

  <div class="phase-bar-wrap fade-in" id="phaseBarWrap"></div>

  <div class="chart-wrap fade-in">
    <div class="chart-title">Daily Spend &amp; ROAS (30 days)</div>
    <div style="position:relative;height:300px">
      <canvas id="chart-daily"></canvas>
    </div>
  </div>
</div>
</section>

<!-- Swim Lanes -->
<section id="swimlanes" class="section">
<div class="container">
  <div class="section-header fade-in">
    <h2>Lifecycle Swim Lanes</h2>
    <div class="section-line"></div>
  </div>
  <div id="swimLanesContainer"></div>
</div>
</section>

<!-- Table -->
<section id="table" class="section">
<div class="container">
  <div class="section-header fade-in">
    <h2>All Creatives</h2>
    <div class="section-line"></div>
  </div>

  <div class="filter-bar fade-in">
    <input type="text" id="filter-search" placeholder="Search creatives..." oninput="filterTable()">
    <select id="filter-phase" onchange="filterTable()">
      <option value="">All Phases</option>
      <option value="scaling">Scaling</option>
      <option value="peak">Peak</option>
      <option value="learning">Learning</option>
      <option value="declining">Declining</option>
    </select>
    <select id="filter-product" onchange="filterTable()">
      <option value="">All Products</option>
      <option value="varapace">Varapace</option>
      <option value="varaspan">Varaspan</option>
      <option value="varacare">VaraCare</option>
    </select>
    <select id="filter-format" onchange="filterTable()">
      <option value="">All Formats</option>
      <option value="video">Video</option>
      <option value="image">Image</option>
      <option value="carousel">Carousel</option>
    </select>
    <select id="filter-action" onchange="filterTable()">
      <option value="">All Actions</option>
      <option value="scale">SCALE</option>
      <option value="maintain">MAINTAIN</option>
      <option value="watch">WATCH</option>
      <option value="kill">KILL</option>
      <option value="test">TEST</option>
      <option value="monitor">MONITOR</option>
    </select>
    <span class="filter-count"><span id="row-count">0</span></span>
  </div>

  <div class="data-table-wrap fade-in">
    <table class="data-table" id="creative-table">
      <thead>
        <tr>
          <th onclick="sortTable(0)">Creative <span class="sort-icon">&#8597;</span></th>
          <th onclick="sortTable(1)">Product <span class="sort-icon">&#8597;</span></th>
          <th onclick="sortTable(2)">Phase <span class="sort-icon">&#8597;</span></th>
          <th onclick="sortTable(3)">Spend <span class="sort-icon">&#8597;</span></th>
          <th onclick="sortTable(4)">7d Spend <span class="sort-icon">&#8597;</span></th>
          <th onclick="sortTable(5)">ROAS <span class="sort-icon">&#8597;</span></th>
          <th onclick="sortTable(6)">7d ROAS <span class="sort-icon">&#8597;</span></th>
          <th onclick="sortTable(7)">CPP <span class="sort-icon">&#8597;</span></th>
          <th onclick="sortTable(8)">CTR <span class="sort-icon">&#8597;</span></th>
          <th onclick="sortTable(9)">Days <span class="sort-icon">&#8597;</span></th>
          <th onclick="sortTable(10)">Health <span class="sort-icon">&#8597;</span></th>
          <th onclick="sortTable(11)">Action <span class="sort-icon">&#8597;</span></th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
</div>
</section>

<!-- Funnel -->
<section id="funnel" class="section">
<div class="container">
  <div class="section-header fade-in">
    <h2>Conversion Funnel (14 days)</h2>
    <div class="section-line"></div>
  </div>
  <div class="funnel-wrap fade-in" id="funnelWrap"></div>
</div>
</section>

<!-- Alerts -->
<section id="alerts" class="section">
<div class="container">
  <div class="section-header fade-in">
    <h2>Alerts &amp; Recommendations</h2>
    <div class="section-line"></div>
  </div>
  <div class="alerts-grid" id="alertsGrid"></div>
</div>
</section>

<!-- Footer -->
<div class="footer" id="dashboardFooter"></div>

</div><!-- end dashboard-wrap -->

<!-- Creative Detail Modal -->
<div class="modal-overlay" id="creativeModal" onclick="if(event.target===this)closeCreativeModal()">
  <div class="modal">
    <button class="modal-close" onclick="closeCreativeModal()">&#10005;</button>
    <div class="modal-media" id="modalMedia"></div>
    <div class="modal-details" id="modalDetails"></div>
  </div>
</div>

<script>
// ── Config ──
const SUPABASE_URL = 'https://dyktmiyvpnayqwwlqspe.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5a3RtaXl2cG5heXF3d2xxc3BlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1OTUxOTIsImV4cCI6MjA4NzE3MTE5Mn0.2Ij_ZJs_VJPFhy81Vm_bm6J8RCjI3t4rKICAr00IRYs';
const ACCOUNT_ID = 'act_1215738472466123';
const WORKSPACE_ID = 'de8e2554-729a-422e-894d-ce399eca3a41';

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let DATA = { daily: [], creatives: [], actionColors: {}, phaseColors: {} };

// ── Auth ──
async function checkSession() {
  const { data: { session } } = await sb.auth.getSession();
  if (session) {
    document.getElementById('loginOverlay').classList.add('hidden');
    await loadDashboard();
  }
}

async function handleLogin() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  const errEl = document.getElementById('loginError');
  const btn = document.getElementById('loginBtn');
  errEl.style.display = 'none';
  btn.disabled = true;
  btn.textContent = 'Signing in...';

  const { error } = await sb.auth.signInWithPassword({ email, password });
  if (error) {
    errEl.textContent = error.message;
    errEl.style.display = 'block';
    btn.disabled = false;
    btn.textContent = 'Sign In';
    return;
  }
  document.getElementById('loginOverlay').classList.add('hidden');
  await loadDashboard();
}

async function handleLogout() {
  await sb.auth.signOut();
  location.reload();
}

// Allow Enter key on login form
document.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !document.getElementById('loginOverlay').classList.contains('hidden')) {
    handleLogin();
  }
});

// ── Scoring (ported from Python) ──
function classifyCreative(row, ad7dMap) {
  const phase = (row.lifecycle_phase || 'unknown').toLowerCase();
  const ltRoas = Number(row.lifetime_roas) || 0;
  const ltSpend = Number(row.lifetime_spend) || 0;
  const ltCtr = Number(row.lifetime_ctr) || 0;
  const days = Number(row.days_active) || 1;
  const fatigue = row.current_fatigue_score != null ? Number(row.current_fatigue_score) : null;
  const d7 = ad7dMap[row.ad_id] || {};
  let roas7d = Number(d7.roas_7d) || 0;
  let spend7d = Number(d7.spend_7d) || 0;
  let ctr7d = Number(d7.ctr_7d) || 0;
  if (roas7d === 0 && ltRoas > 0) roas7d = ltRoas;
  const roasDelta = (ltRoas > 0 && roas7d > 0) ? ((roas7d - ltRoas) / ltRoas) * 100 : 0;
  const roasTrend = roasDelta > 10 ? 'up' : roasDelta < -10 ? 'down' : 'flat';
  let action;
  if (phase === 'declining' || (fatigue !== null && fatigue < 30)) action = 'KILL';
  else if (phase === 'scaling' && roas7d >= 2) action = 'SCALE';
  else if (phase === 'peak' && roas7d >= 1.5) action = 'MAINTAIN';
  else if (phase === 'peak' && roas7d < 1.5) action = 'WATCH';
  else if (phase === 'learning' && ltSpend < 5000) action = 'TEST';
  else action = 'MONITOR';
  const roasScore = Math.min(40, (roas7d / 3) * 40);
  const ctrUse = ctr7d > 0 ? ctr7d : ltCtr;
  const ctrScore = Math.min(20, (ctrUse / 1.5) * 20);
  const recencyScore = Math.max(0, 20 - Math.max(0, days - 60) * 0.5);
  const fatigueHealth = fatigue ?? 100;
  const fatigueScoreVal = (fatigueHealth / 100) * 20;
  const health = Math.min(100, Math.round(roasScore + ctrScore + recencyScore + fatigueScoreVal));
  return { action, health, roas_7d: +roas7d.toFixed(2), spend_7d: +spend7d.toFixed(2),
           ctr_7d: +ctrUse.toFixed(2), roas_trend: roasTrend, roas_delta: +roasDelta.toFixed(1) };
}

function computePortfolioHealth(creatives) {
  if (!creatives.length) return 0;
  const phases = {};
  creatives.forEach(c => { const p = (c.lifecycle_phase || 'unknown').toLowerCase(); phases[p] = (phases[p] || 0) + 1; });
  const total = creatives.length;
  const scaling = (phases['scaling'] || 0) / total;
  const peak = (phases['peak'] || 0) / total;
  const learning = (phases['learning'] || 0) / total;
  const declining = (phases['declining'] || 0) / total;
  const balance = Math.min(25, (scaling > 0.05 ? 8 : 0) + (peak > 0.3 ? 8 : 0) + (learning > 0.1 ? 5 : 0) + (declining < 0.1 ? 4 : 0));
  const avgRoas = creatives.reduce((s, c) => s + (c.roas_7d || 0), 0) / total;
  const roasPoints = Math.min(40, (avgRoas / 2) * 40);
  const products = new Set(creatives.map(c => (c.product || '').toLowerCase()));
  const diversity = Math.min(20, products.size * 7);
  const healthAvg = creatives.reduce((s, c) => s + (c.health || 0), 0) / total;
  const creativeHealth = Math.min(15, (healthAvg / 100) * 15);
  return Math.min(100, Math.round(balance + roasPoints + diversity + creativeHealth));
}

// ── Data Loading ──
async function loadDashboard() {
  document.getElementById('loadingOverlay').classList.remove('hidden');

  const [dailyRes, creativesRes, ad7dRes] = await Promise.all([
    sb.rpc('dashboard_daily', { p_account_id: ACCOUNT_ID, p_days: 30 }),
    sb.rpc('dashboard_creatives', { p_workspace_id: WORKSPACE_ID }),
    sb.rpc('dashboard_ad_7d', { p_account_id: ACCOUNT_ID, p_limit: 200 })
  ]);

  if (dailyRes.error) { console.error('daily error:', dailyRes.error); }
  if (creativesRes.error) { console.error('creatives error:', creativesRes.error); }
  if (ad7dRes.error) { console.error('ad7d error:', ad7dRes.error); }

  const ad7d = {};
  (ad7dRes.data || []).forEach(r => { ad7d[r.ad_id] = r; });

  const creatives = (creativesRes.data || []).map(c => ({
    ...c,
    ...classifyCreative(c, ad7d)
  }));

  DATA = {
    daily: dailyRes.data || [],
    creatives,
    actionColors: { SCALE: '#3b82f6', MAINTAIN: '#22c55e', WATCH: '#eab308', KILL: '#ef4444', TEST: '#a855f7', MONITOR: '#71717a' },
    phaseColors: { scaling: '#8b5cf6', peak: '#22c55e', learning: '#3b82f6', declining: '#eab308', fatigued: '#ef4444', paused: '#71717a' }
  };

  renderDashboard();
  document.getElementById('loadingOverlay').classList.add('hidden');
  document.getElementById('dashboardWrap').classList.add('visible');

  const now = new Date();
  document.getElementById('lastRefresh').textContent = 'Updated ' + now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });

  // Default to table view
  setTimeout(() => {
    document.getElementById('table').scrollIntoView({ behavior: 'auto' });
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    const tableTab = document.querySelector('a[href="#table"]');
    if (tableTab) tableTab.classList.add('active');
    sortTable(3);
  }, 100);
}

async function refreshDashboard() {
  // Destroy existing charts to avoid canvas reuse errors
  Chart.helpers.each(Chart.instances, (instance) => { instance.destroy(); });
  await loadDashboard();
}

// ── Helpers ──
function fmtCurrency(v) {
  v = Number(v) || 0;
  if (v >= 100000) return '\u20B9' + (v / 100000).toFixed(1) + 'L';
  if (v >= 1000) return '\u20B9' + (v / 1000).toFixed(1) + 'K';
  return '\u20B9' + Math.round(v);
}

function fmtNum(v) {
  v = Number(v) || 0;
  if (v >= 100000) return (v / 100000).toFixed(1) + 'L';
  if (v >= 1000) return (v / 1000).toFixed(1) + 'K';
  return v.toFixed(0);
}

// ── Render All Sections ──
function renderDashboard() {
  renderHero();
  renderKPIs();
  renderPhaseBar();
  renderSwimLanes();
  renderTable();
  renderFunnel();
  renderAlerts();
  renderFooter();
  initSparklines();
  dailyChart();
  initAnimations();
  initNavTracking();
}

// ── Hero ──
function renderHero() {
  const count = DATA.creatives.length;
  const portfolioHealth = computePortfolioHealth(DATA.creatives);
  document.getElementById('heroSub').textContent = `Live performance intelligence for ${count} active creatives \u2022 Last 14 days`;
  document.getElementById('portfolioScore').textContent = portfolioHealth + '/100';
}

// ── KPI Cards ──
function renderKPIs() {
  const d = DATA.daily;
  if (!d.length) return;
  const last14 = d.slice(-14);
  const prior14 = d.length >= 28 ? d.slice(-28, -14) : d.slice(0, Math.max(1, d.length - 14));

  const sum = (arr, key) => arr.reduce((s, r) => s + (Number(r[key]) || 0), 0);
  const curSpend = sum(last14, 'spend');
  const priorSpend = sum(prior14, 'spend');
  const curPurchases = sum(last14, 'purchases');
  const priorPurchases = sum(prior14, 'purchases');
  const curRevenue = sum(last14, 'revenue');
  const priorRevenue = sum(prior14, 'revenue');
  const curRoas = curSpend > 0 ? curRevenue / curSpend : 0;
  const priorRoas = priorSpend > 0 ? priorRevenue / priorSpend : 0;
  const curCpp = curPurchases > 0 ? curSpend / curPurchases : 0;
  const priorCpp = priorPurchases > 0 ? priorSpend / priorPurchases : 0;
  const activeAds = DATA.creatives.length;

  const delta = (cur, prior) => {
    if (prior === 0) return { pct: 0, cls: 'up' };
    const pct = ((cur - prior) / prior * 100);
    return { pct: Math.abs(pct).toFixed(0), cls: pct >= 0 ? 'up' : 'down', arrow: pct >= 0 ? '\u2191' : '\u2193' };
  };

  const kpis = [
    { label: 'Spend (14d)', val: fmtCurrency(curSpend), delta: delta(curSpend, priorSpend), sparkId: 'spark-spend', invert: true },
    { label: 'ROAS', val: curRoas.toFixed(2) + 'x', delta: delta(curRoas, priorRoas), sparkId: 'spark-roas' },
    { label: 'Cost/Purchase', val: fmtCurrency(curCpp), delta: delta(curCpp, priorCpp), sparkId: 'spark-cpp', invert: true },
    { label: 'Purchases', val: curPurchases, delta: delta(curPurchases, priorPurchases), sparkId: 'spark-purchases' },
    { label: 'Active Ads', val: activeAds, delta: { pct: '', cls: 'up', arrow: '' }, sparkId: null }
  ];

  const grid = document.getElementById('kpiGrid');
  grid.innerHTML = kpis.map(k => {
    const dCls = k.invert ? (k.delta.cls === 'up' ? 'down' : 'up') : k.delta.cls;
    return `<div class="kpi-card">
      <div class="kpi-label">${k.label}</div>
      <div class="kpi-val">${k.val}</div>
      ${k.delta.pct ? `<div class="kpi-delta ${dCls}">${k.delta.arrow} ${k.delta.pct}% vs prior</div>` : '<div class="kpi-delta" style="color:var(--text-dim)">—</div>'}
      ${k.sparkId ? `<div class="spark-wrap"><canvas id="${k.sparkId}" class="kpi-spark"></canvas></div>` : ''}
    </div>`;
  }).join('');
}

// ── Phase Bar ──
function renderPhaseBar() {
  const phases = { scaling: 0, peak: 0, learning: 0, declining: 0 };
  DATA.creatives.forEach(c => {
    const p = (c.lifecycle_phase || '').toLowerCase();
    if (phases.hasOwnProperty(p)) phases[p]++;
  });
  const total = DATA.creatives.length || 1;
  const colors = { scaling: '#8b5cf6', peak: '#22c55e', learning: '#3b82f6', declining: '#eab308' };

  document.getElementById('phaseBarWrap').innerHTML = `
    <div class="phase-bar-title">CREATIVE HEALTH DISTRIBUTION</div>
    <div class="phase-bar">
      ${Object.entries(phases).map(([p, n]) => n > 0 ? `<div class="phase-seg" style="flex:${n};background:${colors[p]}">${n}</div>` : '').join('')}
    </div>
    <div class="phase-legend">
      ${Object.entries(phases).map(([p, n]) => `<span><div class="legend-dot" style="background:${colors[p]}"></div>${p.charAt(0).toUpperCase() + p.slice(1)} (${n})</span>`).join('')}
    </div>
  `;
}

// ── Swim Lanes ──
function renderSwimLanes() {
  const container = document.getElementById('swimLanesContainer');
  const laneOrder = ['scaling', 'peak', 'learning', 'declining'];
  const colors = DATA.phaseColors;

  const grouped = {};
  laneOrder.forEach(p => grouped[p] = []);
  DATA.creatives.forEach(c => {
    const p = (c.lifecycle_phase || '').toLowerCase();
    if (grouped[p]) grouped[p].push(c);
  });

  // Sort each lane
  grouped.scaling.sort((a, b) => (b.roas_7d || 0) - (a.roas_7d || 0));
  grouped.peak.sort((a, b) => (Number(b.lifetime_spend) || 0) - (Number(a.lifetime_spend) || 0));
  grouped.learning.sort((a, b) => (Number(b.lifetime_spend) || 0) - (Number(a.lifetime_spend) || 0));
  grouped.declining.sort((a, b) => (Number(b.lifetime_spend) || 0) - (Number(a.lifetime_spend) || 0));

  container.innerHTML = laneOrder.map(phase => {
    const ads = grouped[phase];
    if (!ads.length) return '';
    const color = colors[phase] || '#71717a';
    const avgRoas = (ads.reduce((s, c) => s + (c.roas_7d || 0), 0) / ads.length).toFixed(2);
    const totalSpend7d = ads.reduce((s, c) => s + (c.spend_7d || 0), 0);

    const cards = ads.map(c => {
      const ac = DATA.actionColors[c.action] || '#71717a';
      const pc = colors[phase];
      const prc = c.product === 'Varapace' ? '#6366f1' : c.product === 'Varaspan' ? '#06b6d4' : c.product === 'VaraCare' ? '#22c55e' : '#71717a';
      const trendIcon = c.roas_trend === 'up' ? '\u2191' : c.roas_trend === 'down' ? '\u2193' : '\u2192';
      const trendColor = c.roas_trend === 'up' ? '#22c55e' : c.roas_trend === 'down' ? '#ef4444' : '#71717a';
      const thumbImg = c.thumb ? `<img src="${c.thumb}" width="280" height="160" style="width:100%;height:100%;object-fit:cover" loading="lazy" onerror="this.style.display='none'">` : '';
      const healthColor = c.health >= 70 ? '#22c55e' : c.health >= 40 ? '#eab308' : '#ef4444';

      return `<div class="creative-card" onclick="openCreativeModal('${c.ad_id}')">
        <div class="card-thumb">${thumbImg}</div>
        <div class="card-body">
          <div class="card-badges">
            <span class="badge" style="background:${prc}20;color:${prc}">${c.product || 'Other'}</span>
            <span class="badge" style="background:#ffffff10;color:#71717a">${c.format || 'Other'}</span>
          </div>
          <div class="card-name" title="${c.ad_name || ''}">${c.ad_name || 'Unknown'}</div>
          <div class="card-metrics">
            <div class="cm"><div class="cm-label">ROAS</div><div class="cm-val">${(Number(c.lifetime_roas) || 0).toFixed(2)}x</div></div>
            <div class="cm"><div class="cm-label">Spend</div><div class="cm-val">${fmtCurrency(c.lifetime_spend)}</div></div>
            <div class="cm"><div class="cm-label">7d ROAS</div><div class="cm-val" style="color:${trendColor}">${c.roas_7d.toFixed(2)}x ${trendIcon}</div></div>
            <div class="cm"><div class="cm-label">CPP</div><div class="cm-val">${fmtCurrency(c.lifetime_cpp)}</div></div>
          </div>
          <div class="card-footer">
            <div class="health-bar-mini"><div class="health-fill" style="width:${c.health}%;background:${healthColor}"></div></div>
            <span class="action-badge" style="background:${ac}20;color:${ac}">${c.action}</span>
          </div>
        </div>
      </div>`;
    }).join('');

    return `<div class="swim-lane fade-in">
      <div class="lane-header">
        <div class="lane-title">
          <div class="lane-dot" style="background:${color}"></div>
          <span class="lane-name">${phase.charAt(0).toUpperCase() + phase.slice(1)}</span>
          <span class="lane-count">${ads.length}</span>
        </div>
        <div class="lane-stats">
          <span>Avg ROAS: <b>${avgRoas}x</b></span>
          <span>7d Spend: <b>${fmtCurrency(totalSpend7d)}</b></span>
        </div>
      </div>
      <div class="lane-scroll">${cards}</div>
    </div>`;
  }).join('');
}

// ── Table ──
function renderTable() {
  const tbody = document.getElementById('tableBody');
  const fmtIcon = (f) => {
    f = (f || '').toLowerCase();
    if (f === 'video') return '\uD83C\uDFA5';
    if (f === 'carousel') return '\uD83D\uDDBC\uFE0F';
    return '\uD83D\uDCF7';
  };

  tbody.innerHTML = DATA.creatives.map(c => {
    const phase = (c.lifecycle_phase || 'unknown').toLowerCase();
    const product = (c.product || 'Other').toLowerCase();
    const fmt = (c.format || 'Other').toLowerCase();
    const action = (c.action || 'MONITOR').toLowerCase();
    const name = (c.ad_name || '').toLowerCase();
    const ac = DATA.actionColors[c.action] || '#71717a';
    const pc = DATA.phaseColors[phase] || '#71717a';
    const prc = product === 'varapace' ? '#6366f1' : product === 'varaspan' ? '#06b6d4' : product === 'varacare' ? '#22c55e' : '#71717a';
    const trendIcon = c.roas_trend === 'up' ? '\u2191' : c.roas_trend === 'down' ? '\u2193' : '\u2192';
    const trendColor = c.roas_trend === 'up' ? '#22c55e' : c.roas_trend === 'down' ? '#ef4444' : '#e4e4e7';
    const healthColor = c.health >= 70 ? '#22c55e' : c.health >= 40 ? '#eab308' : '#ef4444';
    const ltSpend = Number(c.lifetime_spend) || 0;
    const ltRoas = Number(c.lifetime_roas) || 0;
    const ltCpp = Number(c.lifetime_cpp) || 0;
    const ltCtr = Number(c.lifetime_ctr) || 0;
    const days = Number(c.days_active) || 0;

    const thumbCell = c.thumb
      ? `<img src="${c.thumb}" width="44" height="44" style="border-radius:6px;object-fit:cover;flex-shrink:0" loading="lazy" onerror="this.style.display='none'">`
      : '<div class="thumb-placeholder">\uD83D\uDCC4</div>';

    return `<tr data-phase="${phase}" data-product="${product}" data-format="${fmt}" data-action="${action}" data-name="${name}" data-ad-id="${c.ad_id}" onclick="openCreativeModal('${c.ad_id}')" style="cursor:pointer">
      <td class="td-creative"><div class="creative-cell">${thumbCell}<div class="creative-info"><span class="table-name">${c.ad_name || 'Unknown'}</span><span class="table-sub">${fmtIcon(c.format)} ${c.format || 'Other'}</span></div></div></td>
      <td><span class="badge-sm" style="background:${prc}20;color:${prc}">${c.product || 'Other'}</span></td>
      <td><span class="badge-sm" style="background:${pc}20;color:${pc}">${c.lifecycle_phase || 'Unknown'}</span></td>
      <td data-sort="${ltSpend}" class="td-num">${fmtCurrency(ltSpend)}</td>
      <td data-sort="${c.spend_7d}" class="td-num">${c.spend_7d > 0 ? fmtCurrency(c.spend_7d) : '\u2014'}</td>
      <td data-sort="${ltRoas}" class="td-num">${ltRoas.toFixed(2)}x</td>
      <td data-sort="${c.roas_7d}" class="td-num" style="color:${trendColor}">${c.roas_7d.toFixed(2)}x ${trendIcon}</td>
      <td data-sort="${ltCpp}" class="td-num">${fmtCurrency(ltCpp)}</td>
      <td data-sort="${ltCtr}" class="td-num">${(ltCtr * 100).toFixed(2)}%</td>
      <td data-sort="${days}" class="td-num">${days}d</td>
      <td data-sort="${c.health}" class="td-num"><div class="health-bar-table"><div style="width:${c.health}%;height:100%;background:${healthColor};border-radius:4px"></div></div><span class="health-num">${c.health}</span></td>
      <td><span class="action-badge-sm" style="background:${ac}20;color:${ac}">${c.action}</span></td>
    </tr>`;
  }).join('');

  document.getElementById('row-count').textContent = DATA.creatives.length + ' creatives';
}

// ── Funnel ──
function renderFunnel() {
  const d = DATA.daily.slice(-14);
  const sum = (key) => d.reduce((s, r) => s + (Number(r[key]) || 0), 0);

  const steps = [
    { label: 'Impressions', key: 'impressions' },
    { label: 'Link Clicks', key: 'link_clicks' },
    { label: 'Landing Page Views', key: 'lpv' },
    { label: 'Add to Cart', key: 'atc' },
    { label: 'Checkout Initiated', key: 'ic' },
    { label: 'Purchases', key: 'purchases' }
  ];

  const vals = steps.map(s => ({ ...s, val: sum(s.key) }));
  const maxVal = vals[0].val || 1;

  // Funnel steps HTML
  const stepsHtml = vals.map((s, i) => {
    const pct = ((s.val / maxVal) * 100).toFixed(0);
    const convRate = i > 0 && vals[i - 1].val > 0 ? ((s.val / vals[i - 1].val) * 100).toFixed(1) : '';
    return `<div class="funnel-step">
      <div class="funnel-info">
        <span class="funnel-label">${s.label}</span>
        <span class="funnel-val">${fmtNum(s.val)}</span>
        ${convRate ? `<span class="funnel-conv">${convRate}%</span>` : ''}
      </div>
      <div class="funnel-bar-wrap"><div class="funnel-bar" style="width:${pct}%"></div></div>
    </div>`;
  }).join('');

  // Leak rates
  const leaks = [];
  for (let i = 1; i < vals.length; i++) {
    const drop = vals[i - 1].val > 0 ? ((1 - vals[i].val / vals[i - 1].val) * 100).toFixed(1) : 0;
    leaks.push({ from: vals[i - 1].label, to: vals[i].label, drop });
  }
  const worstLeak = leaks.reduce((w, l) => Number(l.drop) > Number(w.drop) ? l : w, leaks[0]);

  const leakHtml = leaks.map(l => `
    <div class="leak-item">
      <span>${l.from} \u2192 ${l.to}</span>
      <span class="leak-rate" style="color:${Number(l.drop) > 50 ? '#ef4444' : Number(l.drop) > 20 ? '#eab308' : '#22c55e'}">${l.drop}% drop</span>
    </div>
  `).join('');

  document.getElementById('funnelWrap').innerHTML = `
    <div class="funnel-steps">${stepsHtml}</div>
    <div class="funnel-health">
      <h3>Funnel Health</h3>
      ${leakHtml}
      ${worstLeak ? `<div class="worst-leak"><strong>Biggest leak:</strong> ${worstLeak.from} \u2192 ${worstLeak.to} (${worstLeak.drop}% drop)</div>` : ''}
    </div>
  `;
}

// ── Alerts ──
function renderAlerts() {
  const creatives = DATA.creatives;
  const alerts = [];

  // Scale-ready
  const scaleReady = creatives.filter(c => c.action === 'SCALE');
  if (scaleReady.length > 0) {
    alerts.push({
      icon: '\uD83D\uDE80', title: `${scaleReady.length} Ads Ready to Scale`,
      desc: `These ads are in scaling phase with 7d ROAS >= 2x. Consider increasing budgets.`,
      action: 'Review scaling ads in Swim Lanes',
      color: '#3b82f6'
    });
  }

  // Underperforming peak
  const watchAds = creatives.filter(c => c.action === 'WATCH');
  if (watchAds.length > 0) {
    alerts.push({
      icon: '\u26A0\uFE0F', title: `${watchAds.length} Peak Ads Underperforming`,
      desc: `These peak-phase ads have 7d ROAS below 1.5x. They may need creative refresh or audience optimization.`,
      action: 'Filter table by WATCH action',
      color: '#eab308'
    });
  }

  // Learning
  const learningAds = creatives.filter(c => c.action === 'TEST');
  if (learningAds.length > 0) {
    alerts.push({
      icon: '\uD83E\uDDEA', title: `${learningAds.length} Ads in Learning Phase`,
      desc: `New ads still gathering data. Avoid making changes until they exit the learning phase.`,
      action: 'Monitor in Table view',
      color: '#a855f7'
    });
  }

  // Kill candidates
  const killAds = creatives.filter(c => c.action === 'KILL');
  if (killAds.length > 0) {
    alerts.push({
      icon: '\uD83D\uDED1', title: `${killAds.length} Ads to Turn Off`,
      desc: `These ads are declining or fatigued with poor ROAS. Consider pausing to reallocate budget.`,
      action: 'Filter table by KILL action',
      color: '#ef4444'
    });
  }

  document.getElementById('alertsGrid').innerHTML = alerts.map(a => `
    <div class="alert-card" style="border-left:4px solid ${a.color}">
      <div class="alert-header">
        <span class="alert-icon">${a.icon}</span>
        <span class="alert-title">${a.title}</span>
      </div>
      <div class="alert-desc">${a.desc}</div>
      <div class="alert-action">${a.action}</div>
    </div>
  `).join('');
}

// ── Footer ──
function renderFooter() {
  const now = new Date();
  const ts = now.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' }) + ', ' +
             now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
  const health = computePortfolioHealth(DATA.creatives);
  document.getElementById('dashboardFooter').textContent =
    `Live data \u2022 ${ts} \u2022 ${DATA.creatives.length} creatives analyzed \u2022 Portfolio Health: ${health}/100`;
}

// ── Sparkline renderer ──
function sparkline(canvasId, values, color) {
  const canvas = document.getElementById(canvasId);
  if (!canvas || !values.length) return;
  new Chart(canvas, {
    type: 'line',
    data: {
      labels: values.map((_, i) => i),
      datasets: [{ data: values, borderColor: color, borderWidth: 1.5, pointRadius: 0, fill: true, backgroundColor: color + '15', tension: 0.4 }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false }, tooltip: { enabled: false } },
      scales: { x: { display: false }, y: { display: false } }
    }
  });
}

// ── Daily chart ──
function dailyChart() {
  const d = DATA.daily;
  if (!d || !d.length) return;
  const canvas = document.getElementById('chart-daily');
  if (!canvas) return;
  new Chart(canvas, {
    type: 'bar',
    data: {
      labels: d.map(r => r.date ? String(r.date).slice(5) : ''),
      datasets: [
        {
          label: 'Spend', data: d.map(r => Number(r.spend) || 0),
          backgroundColor: 'rgba(99,102,241,0.6)', borderRadius: 4,
          yAxisID: 'y', order: 2
        },
        {
          label: 'ROAS', data: d.map(r => Math.min(Number(r.roas) || 0, 5)),
          type: 'line', borderColor: '#22c55e', borderWidth: 2,
          pointRadius: 2, pointBackgroundColor: '#22c55e',
          yAxisID: 'y1', order: 1, tension: 0.3
        },
        {
          label: 'Breakeven', data: d.map(() => 1),
          type: 'line', borderColor: '#ef444480', borderWidth: 1,
          borderDash: [6, 3], pointRadius: 0,
          yAxisID: 'y1', order: 0
        }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { labels: { color: '#71717a', font: { size: 11 } } }
      },
      scales: {
        x: { ticks: { color: '#52525b', font: { size: 10 } }, grid: { display: false } },
        y: { position: 'left', ticks: { color: '#52525b', callback: v => v >= 1000 ? (v / 1000).toFixed(0) + 'K' : v }, grid: { color: '#1e1e2e' } },
        y1: { position: 'right', ticks: { color: '#22c55e', callback: v => v.toFixed(1) + 'x' }, grid: { display: false }, min: 0, max: 5, suggestedMax: 5 }
      }
    }
  });
}

// ── Sparklines from daily data ──
function initSparklines() {
  const d = DATA.daily;
  if (!d || !d.length) return;
  sparkline('spark-spend', d.map(r => Number(r.spend) || 0), '#6366f1');
  sparkline('spark-roas', d.map(r => Number(r.roas) || 0), '#22c55e');
  sparkline('spark-cpp', d.map(r => Number(r.cpp) || 0), '#f97316');
  sparkline('spark-purchases', d.map(r => Number(r.purchases) || 0), '#3b82f6');
}

// ── Table sort ──
let sortCol = -1, sortDir = 1;
function sortTable(col) {
  const table = document.getElementById('creative-table');
  const tbody = table.querySelector('tbody');
  const rows = Array.from(tbody.querySelectorAll('tr'));
  const ths = table.querySelectorAll('th');

  if (sortCol === col) { sortDir *= -1; }
  else { sortCol = col; sortDir = -1; }

  ths.forEach(th => th.classList.remove('sorted'));
  if (ths[col]) ths[col].classList.add('sorted');

  rows.sort((a, b) => {
    let av, bv;
    if (col === 0) {
      av = a.cells[0].textContent.toLowerCase();
      bv = b.cells[0].textContent.toLowerCase();
      return sortDir * av.localeCompare(bv);
    }
    av = parseFloat(a.cells[col].getAttribute('data-sort') || a.cells[col].textContent.replace(/[\u20B9,%xKL ]/g, '')) || 0;
    bv = parseFloat(b.cells[col].getAttribute('data-sort') || b.cells[col].textContent.replace(/[\u20B9,%xKL ]/g, '')) || 0;
    return sortDir * (av - bv);
  });

  rows.forEach(r => tbody.appendChild(r));
}

// ── Table filter ──
function filterTable() {
  const search = document.getElementById('filter-search').value.toLowerCase();
  const phase = document.getElementById('filter-phase').value;
  const product = document.getElementById('filter-product').value;
  const format = document.getElementById('filter-format').value;
  const action = document.getElementById('filter-action').value;
  const rows = document.querySelectorAll('#creative-table tbody tr');
  let visible = 0;

  rows.forEach(row => {
    const rName = row.getAttribute('data-name') || '';
    const rPhase = row.getAttribute('data-phase') || '';
    const rProduct = row.getAttribute('data-product') || '';
    const rFormat = row.getAttribute('data-format') || '';
    const rAction = row.getAttribute('data-action') || '';

    const show = (
      (!search || rName.includes(search)) &&
      (!phase || rPhase === phase) &&
      (!product || rProduct === product) &&
      (!format || rFormat === format) &&
      (!action || rAction === action)
    );
    row.style.display = show ? '' : 'none';
    if (show) visible++;
  });

  document.getElementById('row-count').textContent = visible + ' creatives';
}

// ── Nav smooth scroll ──
function scrollTo_(e, id) {
  e.preventDefault();
  document.getElementById(id).scrollIntoView({ behavior: 'smooth' });
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  e.target.classList.add('active');
}

// ── Scroll animations ──
function initAnimations() {
  const els = document.querySelectorAll('.fade-in');
  const observer = new IntersectionObserver(entries => {
    entries.forEach(e => { if (e.isIntersecting) e.target.classList.add('visible'); });
  }, { threshold: 0.05 });
  els.forEach(el => observer.observe(el));
  setTimeout(() => els.forEach(el => el.classList.add('visible')), 500);
}

// ── Nav active tracking ──
function initNavTracking() {
  const sections = ['overview', 'swimlanes', 'table', 'funnel', 'alerts'];
  const observer = new IntersectionObserver(entries => {
    entries.forEach(e => {
      if (e.isIntersecting) {
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        const tab = document.querySelector(`.nav-tab[href="#${e.target.id}"]`);
        if (tab) tab.classList.add('active');
      }
    });
  }, { threshold: 0.2 });
  sections.forEach(id => {
    const el = document.getElementById(id);
    if (el) observer.observe(el);
  });
}

// ── Creative Detail Modal ──
function openCreativeModal(adId) {
  const c = DATA.creatives.find(x => x.ad_id === adId);
  if (!c) return;

  const overlay = document.getElementById('creativeModal');
  const mediaEl = document.getElementById('modalMedia');
  const detailsEl = document.getElementById('modalDetails');

  const hdThumb = c.hd_thumbnail_url || c.thumb;
  const isVideo = !!c.video_id;

  if (isVideo && hdThumb) {
    mediaEl.innerHTML = `<img src="${hdThumb}" alt="" style="max-width:100%;max-height:80vh;object-fit:contain" onerror="this.src='';this.alt='No image'">
      ${c.video_duration ? '<div style="position:absolute;bottom:12px;left:12px;background:rgba(0,0,0,0.7);color:#fff;padding:4px 10px;border-radius:6px;font-size:12px">\uD83C\uDFA5 ' + Number(c.video_duration).toFixed(1) + 's</div>' : ''}`;
  } else if (hdThumb) {
    mediaEl.innerHTML = `<img src="${hdThumb}" alt="" style="max-width:100%;max-height:80vh;object-fit:contain" onerror="this.src='';this.alt='No image'">`;
  } else {
    mediaEl.innerHTML = '<div style="color:#71717a;font-size:48px">\uD83D\uDCC4</div>';
  }

  const roas7d = c.roas_7d || 0;
  const spend7d = c.spend_7d || 0;
  const ltRoas = Number(c.lifetime_roas) || 0;
  const ltSpend = Number(c.lifetime_spend) || 0;
  const phase = c.lifecycle_phase || 'Unknown';
  const action = c.action || 'MONITOR';
  const health = c.health || 0;
  const product = c.product || 'Other';
  const fmt = c.format || 'Other';
  const daysActive = Number(c.days_active) || 0;
  const ctr = Number(c.lifetime_ctr) || 0;
  const cpm = Number(c.lifetime_cpm) || 0;
  const cpp = Number(c.lifetime_cpp) || 0;

  const ac = DATA.actionColors[action] || '#71717a';
  const pc = DATA.phaseColors[(phase || '').toLowerCase()] || '#71717a';

  const adLibraryUrl = c.ad_library_url || `https://www.facebook.com/ads/library/?id=${adId}`;

  detailsEl.innerHTML = `
    <div class="modal-title">${c.ad_name || 'Unknown'}</div>
    <div class="modal-badges">
      <span class="badge" style="background:${ac}20;color:${ac}">${action}</span>
      <span class="badge" style="background:${pc}20;color:${pc}">${phase}</span>
      <span class="badge" style="background:#ffffff10;color:#71717a">${fmt}</span>
      <span class="badge" style="background:#6366f120;color:#6366f1">${product}</span>
    </div>

    <div class="modal-section">
      <div class="modal-section-title">Performance</div>
      <div class="modal-metrics">
        <div class="modal-metric"><div class="label">7d ROAS</div><div class="value" style="color:${roas7d >= 2 ? '#22c55e' : roas7d >= 1 ? '#eab308' : '#ef4444'}">${roas7d.toFixed(2)}x</div></div>
        <div class="modal-metric"><div class="label">Lifetime ROAS</div><div class="value">${ltRoas.toFixed(2)}x</div></div>
        <div class="modal-metric"><div class="label">7d Spend</div><div class="value">${fmtCurrency(spend7d)}</div></div>
        <div class="modal-metric"><div class="label">Total Spend</div><div class="value">${fmtCurrency(ltSpend)}</div></div>
        <div class="modal-metric"><div class="label">CTR</div><div class="value">${(ctr * 100).toFixed(2)}%</div></div>
        <div class="modal-metric"><div class="label">CPM</div><div class="value">${fmtCurrency(cpm)}</div></div>
        <div class="modal-metric"><div class="label">Cost/Purchase</div><div class="value">${fmtCurrency(cpp)}</div></div>
        <div class="modal-metric"><div class="label">Days Active</div><div class="value">${daysActive}</div></div>
      </div>
    </div>

    <div class="modal-section">
      <div class="modal-section-title">Health Score</div>
      <div style="display:flex;align-items:center;gap:12px">
        <div style="flex:1;height:8px;background:var(--bg);border-radius:4px;overflow:hidden">
          <div style="width:${health}%;height:100%;background:${ac};border-radius:4px"></div>
        </div>
        <span style="font-weight:700;color:${ac}">${health}/100</span>
      </div>
    </div>

    ${c.primary_text ? `<div class="modal-section"><div class="modal-section-title">Ad Copy</div><div class="modal-adcopy">${String(c.primary_text).substring(0, 500)}</div></div>` : ''}

    <div class="modal-actions">
      <a href="${adLibraryUrl}" target="_blank" class="modal-btn primary">View on Facebook</a>
    </div>
  `;

  overlay.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeCreativeModal() {
  document.getElementById('creativeModal').classList.remove('active');
  document.body.style.overflow = '';
  const vid = document.querySelector('#modalMedia video');
  if (vid) vid.pause();
}

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeCreativeModal();
});

// ── Init: check session on page load ──
checkSession();
</script>

</body>
</html>
